#! /usr/bin/env bash

# The goal of this script is install a complete production environment
# for web sites using on Escenic Content Engine as their CMS. The
# script is equally well suited for installing development, testing
# and staging environments, in addition to recover from backups create
# with the "ece -i <instance> backup" command.
#
# Always check for the latest version at
# http://github.com/escenic/ece-scripts

# echo comments and suggestions > tkj@vizrt.com
# echo frustrations > /dev/null

#####################################################################
# User definable variables (the defaults are fine in most
# cases). These are the most likely variables you want to change and
# they can all be set in the ece-install.conf file
#####################################################################
ece_user=escenic
ece_group=escenic
jdbc_driver=/usr/share/java/mysql.jar
debug=0
tomcat_download=http://apache.uib.no/tomcat/tomcat-6/v6.0.35/bin/apache-tomcat-6.0.35.tar.gz

# These variables govern where software is installed and data and run
# time files are written.
dir_suffix=escenic
escenic_root_dir=/opt/${dir_suffix}
escenic_conf_dir=/etc/${dir_suffix}
escenic_log_dir=/var/log/${dir_suffix}
escenic_data_dir=/var/lib/${dir_suffix}
escenic_run_dir=/var/run/${dir_suffix}
escenic_backups_dir=/var/backups/${dir_suffix}
escenic_spool_dir=/var/spool/${dir_suffix}
escenic_cache_dir=/var/cache/${dir_suffix}
escenic_crash_dir=/var/crash/${dir_suffix}
appserver_root_dir=/opt

# country code for selecting the correct (APT) mirror.
mirror_country_suffix=jp


# The script will install the sun-java6-jdk package on Debian based
# systems and this is the path of the JAVA home with this package. If
# you're using a different system or have other preferences, change
# java_home.
java_home=/usr/lib/jvm/java-6-sun
#####################################################################

pid_file=/var/run/$(basename $0).pid
download_dir=/tmp/ece-downloads
log=/var/log/$(basename $0).log
conf_file=$HOME/ece-install.conf
ece_scripts_git_source=git://github.com/skybert/ece-scripts.git
maven_opts="--batch-mode"
wget_opts="--continue --inet4-only --quiet"
apt_opts="--no-install-recommends"
curl_opts="--silent"

# hook scripts
ece_install_scripts_dir=$HOME/ece-install.d

# globals will be set to correct values in run-time.
appserver_host=localhost
appserver_port=8080
on_debian_or_derivative=0
on_debian=0
on_ubuntu=0
force_packages=0

# because the all in one profile will run database, search and app
# server profiles, all of which needs downloading and setting up the
# ECE software components.
ece_software_setup_completed=0

NEW_LINE="
"
# the next steps printed when the user has installed his/her
# components.
next_steps=()

function get_seconds_since_start()
{
    local seconds="n/a"
    
    if [ -r $pid_file ]; then
        now=`date +%s`
        started=`stat -c %Y $pid_file`
        seconds=$(( now - started ))
    fi
    
    echo "$seconds"
}

function get_id()
{
    timestamp=$(get_seconds_since_start)
    echo "[$(basename $0)-${timestamp}]"
}

function debug()
{
    if [ $debug -eq 1 ]; then
        echo "[$(basename $0)-debug]" "$@"
    fi
}

function print()
{
    echo $(get_id) $@
}

function log()
{
    echo $(get_id) $@ >> $log
}

function print_and_log()
{
    print "$@"
    log "$@"
}

function log_call_stack()
{
    log "Call stack (top most is the last one, main is the first):"

    # skipping i=0 as this is log_call_stack itself
    for ((i = 1; i < ${#FUNCNAME[@]}; i++)); do
        echo -n  ${BASH_SOURCE[$i]}:${BASH_LINENO[$i-1]}:${FUNCNAME[$i]}"()" >> $log
        if [ -e ${BASH_SOURCE[$i]} ]; then
            echo -n " => " >> $log
            sed -n "${BASH_LINENO[$i-1]}p" ${BASH_SOURCE[$i]} | \
                sed "s#^[ \t]*##g" >> $log
        else
            echo "" >> $log
        fi
    done
}

function remove_pid_and_exit_in_error()
{
    if [ -e $pid_file ]; then
        rm $pid_file
    fi

    log_call_stack
    
    exit 1
}

function exit_on_error()
{
    if [ $? -gt 0 ]; then
        print "The command ["$@"] FAILED, exiting :-("
        print "See $log for further details."
        remove_pid_and_exit_in_error
    fi
}

function run()
{
    $@ 1>>$log 2>>$log
    exit_on_error $@
}

# Returns 1 if the passed value is a number, 0 if not
#
# $1 : what you want to test
function is_number()
{
    if [ -z $1 ]; then
        echo 0
    elif [ $(echo $1 | grep [a-z] | wc -l) -gt 0 ]; then
        echo 0
    elif [ $(echo $1 | grep [A-Z] | wc -l) -gt 0 ]; then
        echo 0
    else
        echo 1
    fi
}

technet_download_list="
http://technet.escenic.com/downloads/assemblytool-2.0.2.zip
http://technet.escenic.com/downloads/release/53/analysis-engine-2.3.7.0.zip
http://technet.escenic.com/downloads/release/53/community-engine-3.6.1.0.zip
http://technet.escenic.com/downloads/release/53/dashboard-1.0.0.0.zip
http://technet.escenic.com/downloads/release/53/engine-5.3.4.7.zip
http://technet.escenic.com/downloads/release/53/forum-3.0.0.0.zip
http://technet.escenic.com/downloads/release/53/inpage-1.3.0.0.zip
http://technet.escenic.com/downloads/release/53/lucy-dist-4.1.6.0.zip
http://technet.escenic.com/downloads/release/53/menu-editor-dist-2.0.6.0.zip
http://technet.escenic.com/downloads/release/53/poll-2.1.3.0.zip
http://technet.escenic.com/downloads/release/53/xml-editor-dist-2.1.0.0.zip
"

wf_download_list="
http://technet.escenic.com/downloads/widget-framework/widget-framework-core-1.10.0.0.zip
"

PROFILE_ALL_IN_ONE=1
PROFILE_CACHE_SERVER=5
PROFILE_DB_SERVER=4
PROFILE_EDITORIAL_SERVER=2
PROFILE_PRESENTATION_SERVER=3
PROFILE_RMI_HUB=6
PROFILE_SEARCH_SERVER=7
PROFILE_WIDGET_FRAMEWORK=8
PROFILE_CREATE_PUBLICATION=9
PROFILE_MONITORING_SERVER=10
PROFILE_RESTORE_FROM_BACKUP=11
PROFILE_ANALYSIS_SERVER=12

function make_dir()
{
    if [ ! -d $1 ]; then
        run mkdir -p $1
    fi
}

function make_ln()
{
    if [ $2 ]; then
        if [ -e $1 -a ! -h $2 ]; then
            run ln -s $1 $2
        elif [ ! -e $1 ]; then
            print_and_log "Tried to make a symlink to $1, but it doesn't exist"
            remove_pid_and_exit_in_error
        fi
    else
        if [ -e $1 -a ! -h $(basename $1) ]; then
            run ln -s $1
        elif [ ! -e $1 ]; then
            print_and_log "Tried to make a symlink to $1, but it doesn't exist"
            remove_pid_and_exit_in_error
        fi
    fi
}

function set_up_engine_directories()
{
    for el in $engine_dir_list; do
        make_dir $el
    done
}

function download_escenic_components()
{
    if [ $ece_software_setup_completed -eq 1 ]; then
        return
    fi
    
    print_and_log "Downloading Escenic software from technet.escenic.com ..."
    
    cd $download_dir
    for el in $technet_download_list; do
        if [ -e $(basename $el) ]; then
            continue
        fi
        
        run wget $wget_opts \
            --http-user $technet_user \
            --http-password $technet_password \
            $el 
    done

}

# will install the passed packages if these are not installed from
# before.
#
# parameters:
# $1 : space separated string of package names 
function install_packages_if_missing()
{
    if [ $on_debian_or_derivative -eq 1 ]; then
        some_are_missing=0
        for el in $@; do
            # we don't need to grep away "No packages found matching
            # ..." since this message from dpkg is written to standard
            # error.
            if [ $(dpkg -l $el 2>/dev/null | grep ^ii | wc -l) -lt 1 ]; then
                some_are_missing=1
            fi
        done
        
        if [ $some_are_missing -eq 0 ]; then
            return
        fi

        if [ $force_packages -eq 1 ]; then
            run apt-get install $apt_opts --assume-yes --force-yes $@
        else
            run apt-get install $apt_opts --assume-yes $@
        fi
    fi
}


function install_common_os_packages()
{
    print_and_log "Installing 3rd party packages needed by $(basename $0) ..."

    if [ $on_debian_or_derivative -eq 1 ]; then
        # Ubuntu doesn't have git (!) but only git-core.
        if [ $on_ubuntu -eq 1 ]; then
            git_package=git-core
        else
            git_package=git
        fi

        packages="curl $git_package wget unzip"
        install_packages_if_missing $packages
    fi

    for el in lsb_release curl wget git unzip; do
        assert_pre_prequesite $el
    done
}

function set_up_assembly_tool()
{
    print_and_log "Setting up the Assembly Tool ..."
    
    make_dir $escenic_root_dir/assemblytool/
    cd $escenic_root_dir/assemblytool/
    
    if [ -e $download_dir/assemblytool*zip ]; then
        run unzip -q -u $download_dir/assemblytool*zip
    fi

    # adding an instance layer to the Nursery configuration
    cp -r $escenic_root_dir/engine/siteconfig/bootstrap-skeleton \
        $escenic_root_dir/assemblytool/conf
    cd $escenic_root_dir/assemblytool/conf/
    cp -r layers/host layers/instance
    cat > layers/instance/Files.properties <<EOF
\$class=neo.nursery.FileSystemDepot
fileSystemRoot = $escenic_conf_dir/engine/instance/\${com.escenic.instance}/
EOF
    echo "" >> Nursery.properties
    echo "layer.06 = /layers/instance/Layer" >> Nursery.properties

    # fixing the path to the Nursery configuration according to
    # escenic_conf_dir which may have been overridden by the user.
    for el in $(find $escenic_root_dir/assemblytool/conf -name Files.properties)
    do
        sed -i "s#/etc/escenic#${escenic_conf_dir}#g" $el
    done
    
    # set up which plugins to use
    cd $escenic_root_dir/assemblytool/
    make_dir plugins
    cd plugins
    find ../../ -maxdepth 1 -type d | \
        grep -v assemblytool | \
        while read directory; do
        if [ $directory = "../../" -o \
            $(echo $directory | grep widget-framework | wc -l) -gt 0 ]; then
            continue
        fi
        
        # nuisance to get the community engine and analysis engine,
        # but not the engine
        if [ $(echo $directory | \
            grep engine | \
            grep -v community | \
            grep -v analysis | \
            wc -l) -gt 0 ]; then
            continue
        fi

        make_ln $directory
    done

    run cd $escenic_root_dir/assemblytool/
    run ant -q initialize
    sed -i "s~#\ engine.root\ =\ \.~engine.root=${escenic_root_dir}/engine~g" \
        assemble.properties \
        1>>$log 2>>$log
    exit_on_error "sed on assemble.properties"
    
    sed -i "s~\#\# plugins\ =\ /path/to/plugins~plugins=${escenic_root_dir}/assemblytool/plugins~g" \
        assemble.properties \
        1>>$log 2>>$log
    exit_on_error "sed on assemble.properties"

    make_dir $escenic_root_dir/assemblytool/publications

    # set up user publication definitions
    if [ -n "${fai_publication_war_uri_list}" ]; then
        run cd $escenic_root_dir/assemblytool/publications
        
        for el in ${fai_publication_war_uri_list}; do
            if [[ $el == http* ]]; then
                run wget $wget_opts $el
            elif [[ $el == file://* ]]; then
                local file_with_path=$(echo $el | sed "s#file://##g")
                run cp $file_with_path .
            else
                run cp ${el} .
            fi
            
            if [ ! -e $(basename $el) ]; then
                print_and_log "Failed to get user publication $el."
                print_and_log "I will skip it and continue to the next one."
                continue
            fi

            local short_name=$(basename $el .war)
            cat > ${short_name}.properties <<EOF
name: ${short_name}
source-war: ${short_name}.war
context-root: ${short_name}
EOF
            
        done
    fi
    
}

function set_up_engine_and_plugins()
{
    if [ $ece_software_setup_completed -eq 1 ]; then
        return
    fi
    
    print_and_log "Setting up the Escenic Content Engine & its plugins ..."

    make_dir $escenic_root_dir
    cd $escenic_root_dir/

    for el in $technet_download_list; do
        if [ $(basename $el | \
            grep -E "^engine-[0-9]|^engine-trunk-SNAPSHOT|^engine-dist" | \
            wc -l) -gt 0 ]; then
            engine_dir=$(get_base_dir_from_bundle $el)
            engine_file=$(basename $el)
        fi
    done
    
    if [ ! -d ${engine_dir} ]; then
        run unzip -q -u $download_dir/${engine_file}
        if [ -h engine ]; then
            run rm engine
        fi
    
        run ln -s ${engine_dir} engine
    else
        debug "${engine_dir} is already there, skipping to next step."
    fi

    # we now extract all the plugins. We extract them in $escenic_root_dir
    # as we want to re-use them between minor updates of ECE.
    cd $escenic_root_dir/
    for el in $download_dir/*.zip; do
        if [ $(basename $el | grep ^engine-.*.zip | wc -l) -gt 0 ]; then
            continue
        elif [ $(basename $el | grep ^assemblytool-.*.zip | wc -l) -gt 0 ]; then
            continue
        fi
        
        run unzip -q -u $el
    done

    ece_software_setup_completed=1
}

function set_up_ece_scripts()
{
    print_and_log "Setting up the ece UNIX scripts ..." 

    run cd $download_dir
    if [ -d ece-scripts ]; then
        (
            run cd ece-scripts
            run git pull
        )
    else
        run git clone $ece_scripts_git_source
    fi
    
    run cp -r ece-scripts/usr/* /usr/
    run cp -r ece-scripts/etc/escenic/* ${escenic_conf_dir}/
    run cp -r ece-scripts/etc/bash_completion.d/ece /etc/bash_completion.d/
    run cp -r ece-scripts/etc/init.d/* /etc/init.d/
    run cp -r ece-scripts/etc/default/* /etc/default/
    
    local file=${escenic_conf_dir}/ece.conf
    set_conf_file_value assemblytool_home ${escenic_root_dir}/assemblytool $file
    set_conf_file_value backup_dir ${escenic_backups_dir} $file
    set_conf_file_value cache_dir ${escenic_cache_dir} ${file}
    set_conf_file_value ece_home ${escenic_root_dir}/engine ${file}
    set_conf_file_value escenic_conf_dir ${escenic_conf_dir} ${file}
    set_conf_file_value heap_dump_dir ${escenic_crash_dir} ${file}
    set_conf_file_value log_dir ${escenic_log_dir} ${file}
    set_conf_file_value pid_dir ${escenic_run_dir} ${file}
    set_conf_file_value rmi_hub_conf ${escenic_conf_dir}/rmi-hub ${file}
    set_conf_file_value solr_home ${escenic_data_dir}/solr ${file}
    set_conf_file_value ece_security_configuration_dir \
        ${escenic_conf_dir}/engine/common/security \
        ${file}

    run sed -i "s#/etc/escenic#${escenic_conf_dir}#g" /etc/bash_completion.d/ece
    run sed -i "s#/opt/escenic#${escenic_root_dir}#g" /etc/bash_completion.d/ece
}

default_db_port=3306
default_db_host=localhost
default_db_user=ece5user
default_db_password=ece5password
default_db_schema=ece5db

# Method used both from interactive mode to set any missing values
# (defaults)
function set_db_defaults_if_not_set()
{
    if [ -z "$db_host" ]; then
        db_host=${default_db_host}
    fi
    
    if [ -z "$db_port" ]; then
        db_port=${default_db_port}
    fi
    
    if [ -z "$db_user" ]; then
        db_user=${default_db_user}
    fi
    
    if [ -z "$db_password" ]; then
        db_password=${default_db_password}
    fi
    
    if [ -z "$db_schema" ]; then
        db_schema=${default_db_schema}
    fi
}

function set_db_settings_from_fai_conf()
{
    # Note: the port isn't fully supported. The user must himself
    # update the mysql configuration to run it on a non standard port.
    
    if [ $install_profile_number -ne $PROFILE_ANALYSIS_SERVER ]; then
        db_port=${fai_db_port-${default_db_port}}
        db_host=${fai_db_host-${default_db_host}}
        db_user=${fai_db_user-${default_db_user}}
        db_password=${fai_db_password-${default_db_password}}
        db_schema=${fai_db_schema-${default_db_schema}}
    else
        db_port=${fai_analysis_db_port-${default_db_port}}
        db_host=${fai_analysis_db_host-${default_db_host}}
        db_user=${fai_analysis_db_user-${default_db_user}}
        db_password=${fai_analysis_db_password-${default_db_password}}
        db_schema=${fai_analysis_db_schema-${default_db_schema}}
    fi
    
    if [ -n "${fai_db_drop_old_db_first}" ]; then
        drop_db_first=${fai_db_drop_old_db_first}
        if [ $fai_db_drop_old_db_first -eq 1 ]; then
            print_and_log "WARNING: I hope you know what you're doing!"
            print_and_log "WARNING: fai_db_drop_old_db_first is 1 (true)"
        fi
    fi
}

function set_up_ecedb()
{
    print_and_log "Setting up the ECE database schema ..."

    make_dir $escenic_root_dir/engine/plugins
    run cd $escenic_root_dir/engine/plugins
    
    find ../../ -maxdepth 1 -type d | \
        grep -v assemblytool | \
        while read directory; do
        if [ $directory = "../../" ]; then
            continue
        fi
        
          # nuisance to get the community engine, but not the engine
        if [ $(echo $directory | grep engine | wc -l) -gt 0 ]; then
            if [ $(echo $directory | grep community | wc -l) -lt 1 ]; then
                continue
            fi
        fi

        if [ ! -h $(basename $directory) ]; then
            run ln -s $directory
        fi
    done

    # the user may override standard DB settings in ece-install.conf
    set_db_settings_from_fai_conf
    set_db_defaults_if_not_set

    # the methods in drop-and-create-ecedb needs ece_home to be set
    ece_home=${escenic_root_dir}/engine
    pre_install_new_ecedb
    create_ecedb
    
    cd ~/
    run rm -rf $escenic_root_dir/engine/plugins

    add_next_step "DB is now set up on ${db_host}:${db_port}"
}

function set_up_basic_nursery_configuration()
{
    print_and_log "Setting up the basic Nursery configuration ..."

    local escenic_root_dir=$escenic_root_dir
    
    if [ $(is_using_conf_archive) -eq 1 ]; then
        print_and_log "Using the supplied Nursery & JAAS configuration from" 
        print_and_log "bundle: $ece_instance_conf_archive"
        local a_tmp_dir=$(mktemp -d)
        escenic_root_dir=$a_tmp_dir
        run cd $a_tmp_dir
        run tar xzf $ece_instance_conf_archive
    fi
    
    run cp -r $escenic_root_dir/engine/siteconfig/config-skeleton/* \
        $common_nursery_dir/
    run cp -r $escenic_root_dir/engine/security/ \
        $common_nursery_dir/

    make_dir $escenic_conf_dir/engine/instance

    for el in $escenic_root_dir/assemblytool/plugins/*; do
        if [ ! -d $el/misc/siteconfig/ ]; then
            continue
        fi

        run cp -r $el/misc/siteconfig/* $common_nursery_dir/
    done

    if [ -n "${a_tmp_dir}" ]; then
        run rm -rf ${a_tmp_dir}
    fi
    
    public_host_name=$HOSTNAME:${appserver_port}
    if [ $fai_enabled -eq 1 ]; then
        if [ -n "$fai_public_host_name" ]; then
            public_host_name=$fai_public_host_name
        fi
    else
        print "What is the public address of your website?"
        print "Press ENTER to use the default ($public_host_name)"
        echo -n "Your choice [$public_host_name]> "
        read user_host_name
    fi

    if [ -n "$user_host_name" ]; then
        public_host_name=$user_host_name
    fi
    
    cat > $common_nursery_dir/ServerConfig.properties <<EOF
databaseProductName=MySQL
filePublicationRoot=$escenic_data_dir/engine/
webPublicationRoot=http://${public_host_name}/

# These two LDAP settings can be ignored on systems with ECE >= 5.3
ldapProductName=OpenLdap
ldapProductVersion=2.2.26
EOF
    cat > $common_nursery_dir/neo/io/managers/ContentManager.properties <<EOF
readConnector=/connector/ReadConnector
updateConnector=/connector/UpdateConnector
EOF

    file=$common_nursery_dir/com/escenic/community/CommunityEngine.properties
    if [ -w ${file} ]; then
        sed -i 's/jdbc\/ecome/jdbc\/ECE_UPDATE_DS/g' $file
        exit_on_error "sed on $file"
    elif [ ! -e ${file} ]; then
        print_and_log "I Could not find an ECOME configuration file,"
        print_and_log "I assume you have not installed Community Engine."
    else
        print_and_log "Could not write to ${file},"
        print_and_log "Community Engine might not work because of this. "
        remove_pid_and_exit_in_error
    fi

    file=$common_nursery_dir/com/escenic/webstart/StudioConfig.properties
    cat >> $file <<EOF

# We set this to get around a missing feature in Varnish, see:
# https://www.varnish-cache.org/trac/wiki/Future_Feature#Chunkedencodingclientrequests
# For Escenic-ites, see: VF-3480
property.com.escenic.client.chunked=false
EOF
}

function set_up_instance_specific_nursery_configuration()
{
    for el in $escenic_conf_dir/engine/instance/*; do
       i=$(( i + 1 ))
       if [ $(basename $el) = $instance_name ]; then
           rmi_port="8${i}23"
           run echo "port=$rmi_port" > $el/RMI.properties
       fi
    done

    nursery_context=neo/io/managers/HubConnectionManager.properties
    file=$escenic_conf_dir/engine/instance/$instance_name/$nursery_context
    make_dir $(dirname $file)
    
    # we don't touch it if the file already exists.
    if [ ! -e $file ]; then
        run echo "hostname=$HOSTNAME" >> $file
    fi
    
}

function set_up_proper_logging_configuration()
{
    print_and_log "Setting up proper log4j & Java logging configuration ..."
    
    cat > $common_nursery_dir/trace.properties <<EOF
log4j.rootLogger=ERROR, ECELOG
log4j.appender.ECELOG=org.apache.log4j.DailyRollingFileAppender
log4j.appender.ECELOG.File=$escenic_log_dir/\${escenic.server}-messages
log4j.appender.ECELOG.layout=org.apache.log4j.PatternLayout
log4j.appender.ECELOG.layout.ConversionPattern=%d %5p [%t] %x (%c) %m%n
EOF
    cd $tomcat_base/lib/
    make_ln $common_nursery_dir/trace.properties
    run ln -sf trace.properties log4j.properies


    # since the solr webapp otherwise will pollute our logs, we ask
    # Tomcat specifically to make it log to dedicated logger.
    if [ $install_profile_number -eq $PROFILE_SEARCH_SERVER -o \
        $install_profile_number -eq $PROFILE_ALL_IN_ONE ]; then
        cat > $tomcat_base/conf/logging.properties <<EOF
handlers = 1catalina.org.apache.juli.FileHandler, 2localhost.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler, 6localhost.org.apache.juli.FileHandler

.handlers = 1catalina.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler

1catalina.org.apache.juli.FileHandler.level = FINE
1catalina.org.apache.juli.FileHandler.directory = \$\{catalina.base\}/logs
1catalina.org.apache.juli.FileHandler.prefix = catalina.

2localhost.org.apache.juli.FileHandler.level = FINE
2localhost.org.apache.juli.FileHandler.directory = \$\{catalina.base\}/logs
2localhost.org.apache.juli.FileHandler.prefix = localhost.

java.util.logging.ConsoleHandler.level = FINE
java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter

6localhost.org.apache.juli.FileHandler.level = FINE
6localhost.org.apache.juli.FileHandler.directory = $escenic_log_dir
6localhost.org.apache.juli.FileHandler.prefix = solr.

org.apache.solr.level=INFO
org.apache.solr.handlers=6localhost.org.apache.juli.FileHandler

org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO
org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.FileHandler
EOF
    else
        run cp $tomcat_home/conf/logging.properties $tomcat_base/conf
    fi
    
}

# don't quote values when setting conf file values with
# set_conf_file_value. This is a hack-ish variable due to EAE's
# handling of .cfg files.
dont_quote_conf_values=0

# Parameters:
# $1 is the property
# $2 ... to the (last - 1) is the value
# The last argument is the file
#
# e.g.:
# set_conf_file_value \
#   mykey \
#   myvalue1 myvalue2 myvalue3 \
#   /etc/myfile.conf
function set_conf_file_value()
{
    if [ $# -lt 3 ]; then
        return
    fi
    
    local file=${@:${#@}}
    local key=${@:1:1}
    local value_end_index=$(( $# - 2 ))
    local value=${@:2:${value_end_index}}

    local parent_dir=$(dirname $file)
    if [ ! -d ${parent_dir} ]; then
        print ${parent_dir} "doesn't exist, something is wrong :-("
        remove_pid_and_exit_in_error
    fi
    
    if [ -r $file ]; then
        if [ $(grep ^$1 $file | wc -l) -gt 0 ]; then
            if [ $dont_quote_conf_values -eq 0 ]; then
                sed -i "s~$key=.*~$key=\"$value\"~g" $file
            else
                sed -i "s~$key=.*~$key=$value~g" $file
            fi    
        else
            if [ $dont_quote_conf_values -eq 0 ]; then
                echo "$key=\"$value\"" >> $file
            else
                echo "$key=$value" >> $file
            fi
            
        fi
    else
        if [ $dont_quote_conf_values -eq 0 ]; then
            echo "$key=\"$value\"" >> $file
        else
            echo "$key=$value" >> $file
        fi
    fi
}

# The function accepts the following parameters:
# $1 is the property
# $2 is the value
#
# The function will set these for the current instance's ece.conf. If
# the value already is set, it will replace it with this one.
function set_ece_instance_conf()
{
    instance_conf_file=$escenic_conf_dir/ece-$instance_name.conf
    set_conf_file_value $1 $2 $instance_conf_file
}

function create_java_deb_packages_and_repo()
{
    install_packages_if_missing $git_package

    print $(lsb_release -i | cut -d':' -f2) \
        $(lsb_release -r | cut -d':' -f2) \
        "doesn't have official Sun/Oracle Java packages,"
    print "I'm creating packages & local repo for you ..."
    
    local tmp_dir=$(mktemp -d)
    (
        run cd $tmp_dir
        run git clone https://github.com/flexiondotorg/oab-java6.git
        run cd oab-java6
        run bash oab-java6.sh
        run rm -rf $tmp_dir
    )

    add_next_step "Local APT repository with Sun/Oracle Java packages"
    add_next_step "has been installed at /var/local/oab/deb and added"
    add_next_step "to your APT system with /etc/apt/sources.list.d/oab.list"
}

function has_sun_java_installed()
{
    if [[ -x /usr/lib/jvm/java-6-sun/bin/java || \
        $(java -version 2>&1 > /dev/null | grep HotSpot | wc -l) -gt 0 ]]; then
        echo 1
    else
        echo 0
    fi
}

# Installs third party packages needed by the ECE (i.e. Java related).
# Also see install_common_os_packages for packages common to all
# servers in the architecture.
function install_ece_third_party_packages
{
    run_hook install_ece_third_party_packages.preinst
    
    if [ $on_debian_or_derivative -eq 1 ]; then
        if [ $on_ubuntu -eq 1 ]; then
            # Sun Java was removed in Ubuntu in 11.10 
            local version_needs_local_java_deb=1110
            local version=$(lsb_release -s -r | sed "s#\.##g")
            
            add_apt_source \
                "deb http://archive.canonical.com/ $(lsb_release -s -c) partner"
        elif [ $on_debian -eq 1 ]; then
            code_name=$(lsb_release -s -c)
            has_non_free=$(grep $(lsb_release -s -c) \
                /etc/apt/sources.list | \
                egrep -v "^#|deb-src" | \
                grep -v security | \
                grep non-free | \
                wc -l)
            if [ $has_non_free -eq 0 ]; then
                add_apt_source "deb http://ftp.${mirror_country_suffix}.debian.org/debian/ $(lsb_release -s -c) contrib non-free"
            fi

            # Sun Java will be removed in the next Debian stable,
            # wheezy (either 6.1 or 7.0 not announced yet, current in
            # squeeze/6.0, hence setting 6.1 here).
            local version_needs_local_java_deb=610
            local version=$(lsb_release -s -r | sed "s#\.##g")
        fi
        
        if [ $version -ge $version_needs_local_java_deb -a \
            $(has_sun_java_installed) -eq 0 ]; then
            create_java_deb_packages_and_repo
        fi
        
        echo "sun-java6-jdk shared/accepted-sun-dlj-v1-1 boolean true" | \
            debconf-set-selections

        # install sun-java6-jdk first so that ant doesn't pull down OpenJDK
        local packages="sun-java6-jdk"
        install_packages_if_missing $packages

        packages="
          ant
          ant-contrib
          ant-optional
          libapr1
          libtcnative-1
          libmysql-java
          memcached
          maven2
          wget"

        print_and_log "Installing 3rd party packages needed by ECE ..."
        install_packages_if_missing $packages
    fi
    
    for el in ant mvn java; do
        assert_pre_prequesite $el
    done
}

function get_base_dir_from_bundle()
{
    local file_name=$(basename $1)
    suffix=${file_name##*.}

    if [ ${suffix} = "zip" ]; then
        # we'll look inside the archive to determine the base_dir
        file_name=$(
            unzip -t ${download_dir}/$file_name | \
            awk '{print $2}' | \
            cut -d'/' -f1 | \
            sort | \
            uniq | \
            grep -v errors | \
            grep [a-z]
        )
    else
        for el in .tar.gz .tar.bz2 .zip; do
            file_name=${file_name%$el}
        done
    fi
    
    echo $file_name
}

# Returns an escaped string useful for sed and other BASH commands.
#
# $1 :  the string
function get_escaped_bash_string()
{
    local result=$(echo $1 | \
        sed -e 's/\$/\\$/g' \
        -e 's/\*/\\*/g' \
        -e 's#/#\\/#g' \
        -e 's/\./\\./g')
    echo $result
}

# $1 the domain
#
# The method will ensure that the passed domain is resolvable by the
# host on which ece-install is run.
function ensure_domain_is_known_to_local_host()
{
    if [ -z "$1" ]; then
        return 1
    fi
    
    local localhost_ip=$(ping -c 1 localhost 2>/dev/null | \
        head -1 | \
        cut -d'(' -f2 | \
        cut -d')' -f1)
    local hostname_ip=$(ping -c 1 $HOSTNAME 2>/dev/null | \
        head -1 | \
        cut -d'(' -f2 | \
        cut -d')' -f1)
    local domain_ip=$(ping -c 1 $1 2>/dev/null | \
        head -1 | \
        cut -d'(' -f2 | \
        cut -d')' -f1)

    local keep_off_etc_hosts=${fai_keep_off_etc_hosts-0}
    if [[ $domain_ip != $localhost_ip && \
        $domain_ip != hostname_ip && \
        $keep_off_etc_hosts -ne 1 ]]; then
        print_and_log "The domain name ${1} is not resolvable to this host"
        print_and_log "I will remedy this by adding it to /etc/hosts"
        cat >> /etc/hosts <<EOF

# added by $(basename $0) @ $(date)
127.0.1.1 ${1}
EOF
    fi
    if [[ $domain_ip != $localhost_ip && \
        $domain_ip != hostname_ip && \
        $keep_off_etc_hosts -eq 1 ]]; then
        print_and_log "The domain name ${1} is not resolvable to this host"
        print_and_log "but I will keep off /etc/hosts as you've requested."
    fi
}

function set_up_app_server()
{
    print_and_log "Setting up the application server ..."

    if [ $fai_enabled -eq 0 ]; then
        print "On which ports do you wish to run the app server on?"
        print "Press ENTER to accept port 8080 and shutdown port 8005"
        print "Or enter: <port> <shutdown port>, e.g.: '8180 8105'"
        echo -n "Your choice [8080 8005]> "
        read user_ports
        
        if [ -n "$user_ports" ]; then
            appserver_port=$(echo $user_ports | cut -d' ' -f1)
            shutdown_port=$(echo $user_ports | cut -d' ' -f2)
        fi
    else
        if [ $install_profile_number -eq $PROFILE_EDITORIAL_SERVER ]; then
            appserver_port=${fai_editor_port-8080}
            shutdown_port=${fai_editor_shutdown-8005}
        elif [ $install_profile_number -eq $PROFILE_PRESENTATION_SERVER ]; then
            appserver_port=${fai_presentation_port-8080}
            shutdown_port=${fai_presentation_shutdown-8005}
        elif [ $install_profile_number -eq $PROFILE_SEARCH_SERVER ]; then
            appserver_port=${fai_search_port-8080}
            shutdown_port=${fai_search_shutdown-8005}
        elif [ $install_profile_number -eq $PROFILE_ANALYSIS_SERVER ]; then
            appserver_port=${fai_analysis_port-8080}
            shutdown_port=${fai_analysis_shutdown-8005}
        fi
    fi

    if [ -z "$appserver_port" ]; then
        appserver_port=8080
    elif [ -z "$appserver_shutdown" ]; then
        appserver_shutdown=8005
    fi
    
    debug "appserver_port=$appserver_port shutdown_port=$shutdown_port"
    
    if [ $fai_enabled -eq 0 ]; then
        print "Another question: Where does the database run?"
        print "Press ENTER to accept the default " \
            "($HOSTNAME:${default_db_port}:${default_db_schema})"
        print "Or enter: <host>:<port>:<schema>, e.g.: 'db1:${default_db_port}:mydb'"
        echo -n "Your choice [$HOSTNAME:${default_db_port}:schema]> "
        read user_database
        
        db_host=$(echo $user_database | cut -d':' -f1)
        db_port=$(echo $user_database | cut -d':' -f2)
        db_schema=$(echo $user_database | cut -d':' -f3)
    else
        set_db_settings_from_fai_conf
    fi

    set_db_defaults_if_not_set

    if [ $fai_enabled -eq 0 ]; then
        print "Awfully sorry to bug you with so many questions, but:"
        print "What's the URI to the indexer-webservice? (this is typically"
        print "something like http://editor1/indexer-webservice/index/)"
        echo -n "Your choice [http://${HOSTNAME}:8080/indexer-webservice/index/]> "
        read user_indexer_ws_uri
    else
        user_indexer_ws_uri=${fai_search_indexer_ws_uri}
    fi

    if [ -n "$user_indexer_ws_uri" ]; then
        indexer_ws_uri=$user_indexer_ws_uri
    else
        indexer_ws_uri=http://${HOSTNAME}:${appserver_port}/indexer-webservice/index/
    fi
    
    
    if [ $fai_enabled -eq 0 ]; then
        print "Last question, I promise!: Where does the search instance run?"
        print "Press ENTER to accept the default ($HOSTNAME:8080)"
        print "If you're in doubt, just press ENTER :-)"
        print "Or enter: <host>:<port>, e.g.: 'search1:8080'"
        echo -n "Your choice [$HOSTNAME:8080]> "
        read user_search
    else
        user_search=$(get_conf_value fai_search_host)
        if [ -n "${user_search}" ]; then
            user_search=${user_search}":"$(get_conf_value fai_search_port)
        fi
    fi

    if [ -z "$user_search" ]; then
        search_host=$HOSTNAME
        search_port=8080
    else
        search_host=$(echo $user_search | cut -d':' -f1)
        search_port=$(echo $user_search | cut -d':' -f2)
    fi
    
    run cd $download_dir
    run wget $wget_opts $tomcat_download
    tomcat_dir=$(get_base_dir_from_bundle $tomcat_download)
    
    run cd $appserver_root_dir
    run tar xzf $download_dir/${tomcat_dir}.tar.gz

    if [ -e tomcat ]; then
        run rm tomcat
    fi
    run ln -sf ${tomcat_dir} tomcat
    
    tomcat_home=${appserver_root_dir}/tomcat   
    tomcat_base=${appserver_root_dir}/tomcat-${instance_name}
    make_dir $tomcat_base

    run cp -r ${appserver_root_dir}/${tomcat_dir}/conf $tomcat_base
    for el in bin escenic/lib lib work logs temp webapps; do
        make_dir $tomcat_base/$el
    done

    set_ece_instance_conf tomcat_base $tomcat_base   
    set_ece_instance_conf tomcat_home $tomcat_home
    set_ece_instance_conf appserver_port $appserver_port
   
    run cd $tomcat_base/lib
    make_ln $jdbc_driver

    # it's important to append (and not pre-pend) the ECE libraries so
    # that things put it in the standard loader behaves as expected,
    # such as log4j configuration put in ${tomcat.base}/lib.
    file=$tomcat_base/conf/catalina.properties
    common_loader=$(grep ^common.loader $file)
    escaped_common_loader=$(get_escaped_bash_string ${common_loader})
    escenic_loader=",$\{catalina.base\}/escenic/lib/*.jar"
    old=$(get_escaped_bash_string ${common_loader})
    new=${escaped_common_loader}$(get_escaped_bash_string ${escenic_loader})
    run sed -i "s#${old}#${new}#g" $file 
    
    cat > $tomcat_base/conf/server.xml <<EOF
<?xml version='1.0' encoding='utf-8'?>
<Server port="$shutdown_port" shutdown="SHUTDOWN">
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
  <Listener className="org.apache.catalina.core.JasperListener" />
  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
  <Listener className="org.apache.catalina.mbeans.ServerLifecycleListener" />
  <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />

  <GlobalNamingResources>
    <Resource name="UserDatabase"
              auth="Container"
              type="org.apache.catalina.UserDatabase"
              description="User database that can be updated and saved"
              factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
              pathname="conf/tomcat-users.xml"
    />
EOF
    if [ $install_profile_number -ne $PROFILE_ANALYSIS_SERVER \
        -a $install_profile_number -ne $PROFILE_SEARCH_SERVER ]; then
        cat >> $tomcat_base/conf/server.xml <<EOF
    <Resource
        name="jdbc/ECE_READ_DS"
        auth="Container"
        type="javax.sql.DataSource"
        maxActive="400"
        maxIdle="8"
        maxWait="2000"
        initialSize="20"
        username="${db_user}"
        password="${db_password}"
        driverClassName="com.mysql.jdbc.Driver"
        url="jdbc:mysql://${db_host}:${db_port}/${db_schema}?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8"
        removeAbandoned="true"
        removeAbandonedTimeout="120"
        logAbandoned="true"
        testOnBorrow="false"
        testOnReturn="false"
        timeBetweenEvictionRunsMillis="60000"
        numTestsPerEvictionRun="5"
        minEvictableIdleTimeMillis="30000"
        testWhileIdle="true"
        validationQuery="select now()"
    />
    <Resource
        name="jdbc/ECE_UPDATE_DS"
        auth="Container"
        type="javax.sql.DataSource"
        maxActive="100"
        maxIdle="8"
        maxWait="2000"
        initialSize="20"
        username="${db_user}"
        password="${db_password}"
        driverClassName="com.mysql.jdbc.Driver"
        url="jdbc:mysql://${db_host}:${db_port}/${db_schema}?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8"
        removeAbandoned="true"
        removeAbandonedTimeout="120"
        logAbandoned="true"
        testOnBorrow="false"
        testOnReturn="false"
        timeBetweenEvictionRunsMillis="60000"
        numTestsPerEvictionRun="5"
        minEvictableIdleTimeMillis="30000"
        testWhileIdle="true"
        validationQuery="select now()"
    />
EOF
    elif [ $install_profile_number -eq $PROFILE_ANALYSIS_SERVER ]; then
        cat >> $tomcat_base/conf/server.xml <<EOF
    <Resource
        name="jdbc/eae-qs/qs"
        auth="Container"
        type="javax.sql.DataSource"
        maxActive="400"
        maxIdle="8"
        maxWait="2000"
        initialSize="20"
        username="${db_user}"
        password="${db_password}"
        driverClassName="com.mysql.jdbc.Driver"
        url="jdbc:mysql://${db_host}:${db_port}/${db_schema}?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8"
        removeAbandoned="true"
        removeAbandonedTimeout="120"
        logAbandoned="true"
        testOnBorrow="false"
        testOnReturn="false"
        timeBetweenEvictionRunsMillis="60000"
        numTestsPerEvictionRun="5"
        minEvictableIdleTimeMillis="30000"
        testWhileIdle="true"
        validationQuery="select now()"
    />
    <Resource
        name="jdbc/eae-logger/logger"
        auth="Container"
        type="javax.sql.DataSource"
        maxActive="100"
        maxIdle="8"
        maxWait="2000"
        initialSize="20"
        username="${db_user}"
        password="${db_password}"
        driverClassName="com.mysql.jdbc.Driver"
        url="jdbc:mysql://${db_host}:${db_port}/${db_schema}?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;characterSetResults=UTF-8"
        removeAbandoned="true"
        removeAbandonedTimeout="120"
        logAbandoned="true"
        testOnBorrow="false"
        testOnReturn="false"
        timeBetweenEvictionRunsMillis="60000"
        numTestsPerEvictionRun="5"
        minEvictableIdleTimeMillis="30000"
        testWhileIdle="true"
        validationQuery="select now()"
    />
EOF
    fi
    
    cat >> $tomcat_base/conf/server.xml <<EOF
  </GlobalNamingResources>

  <Service name="Catalina">
    <Connector port="${appserver_port}"
               protocol="HTTP/1.1" 
               connectionTimeout="20000" 
               URIEncoding="UTF-8"
               compression="on"
               redirectPort="8543"
    />
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="jvm1">
      <Valve className="org.apache.catalina.valves.AccessLogValve"
             prefix="access."
             suffix=".log"
             pattern="common"/>
      <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
             resourceName="UserDatabase"/>
      <Host name="localhost"
            appBase="webapps"
            unpackWARs="true"
            autoDeploy="true"
            xmlValidation="false"
            xmlNamespaceAware="false">
      </Host>
EOF
    if [[ ($install_profile_number == $PROFILE_EDITORIAL_SERVER || \
        $install_profile_number == $PROFILE_PRESENTATION_SERVER || \
        $install_profile_number == $PROFILE_ALL_IN_ONE) && \
        -n "$fai_publication_domain_mapping_list" ]]; then

        declare -A publication_domain_map
        
        for el in ${fai_publication_domain_mapping_list}; do
            local old_ifs=$IFS
            # the entries in the fai_publication_domain_mapping_list
            # are on the form: <publication>#<domain>
            IFS='#'
            read publication domain <<< "$el"
            publication_domain_map[${publication}]="${domain}"
            IFS=$old_ifs

            ensure_domain_is_known_to_local_host ${domain}
        done
        
        for el in ${!publication_domain_map[@]}; do
            cat >> $tomcat_base/conf/server.xml <<EOF
      <Host name="${publication_domain_map[$el]}" appBase="webapps" autoDeploy="false">
        <Context displayName="${publication_domain_map[$el]}"
                 docBase="${el}"
                 path="/"
        />
      </Host>
EOF
        done
    fi
    
    cat >> $tomcat_base/conf/server.xml <<EOF
    </Engine>
  </Service>
</Server>

EOF
    cat > $tomcat_base/conf/context.xml <<EOF
<?xml version='1.0' encoding='utf-8'?>
<Context>

  <WatchedResource>WEB-INF/web.xml</WatchedResource>
EOF

    if [ $install_profile_number -ne $PROFILE_ANALYSIS_SERVER -a \
        $install_profile_number -ne $PROFILE_SEARCH_SERVER ]; then
        cat >> $tomcat_base/conf/context.xml <<EOF
  <ResourceLink
      global="jdbc/ECE_READ_DS"
      name="jdbc/ECE_READ_DS"
      type="javax.sql.DataSource"
  />
  <ResourceLink
      global="jdbc/ECE_UPDATE_DS"
      name="jdbc/ECE_UPDATE_DS"
      type="javax.sql.DataSource"
  />
EOF
    fi

    if [ $install_profile_number -ne $PROFILE_ANALYSIS_SERVER ]; then
        cat >> $tomcat_base/conf/context.xml <<EOF
  <Environment
      name="escenic/solr-base-uri"
      value="http://${search_host}:${search_port}/solr/"
      type="java.lang.String"
      override="false"
  />
EOF
    fi

    if [ $install_profile_number -eq $PROFILE_SEARCH_SERVER ]; then
        cat >> $tomcat_base/conf/context.xml <<EOF
  <Environment
      name="escenic/indexer-webservice"
      value="http://${indexer_ws_uri}"
      type="java.lang.String"
      override="false"
  />
  <Environment
      name="escenic/index-update-uri"
      value="http://${search_host}:${search_port}/solr/update/"
      type="java.lang.String"
      override="false"
  />
  <Environment
      name="escenic/head-tail-storage-file"
      value="$escenic_data_dir/engine/head-tail.index"
      type="java.lang.String"
      override="false"
  />
  <Environment
      name="escenic/failing-documents-storage-file"
      value="$escenic_data_dir/engine/failures.index"
      type="java.lang.String"
      override="false"
  />
</Context>
EOF
    elif [ $install_profile_number -eq $PROFILE_ANALYSIS_SERVER ]; then
        cat >> $tomcat_base/conf/context.xml <<EOF
  <ResourceLink
      global="jdbc/eae-logger/logger"
      name="jdbc/eae-logger/logger"
      type="javax.sql.DataSource"
  />
  <ResourceLink
      global="jdbc/eae-qs/qs"
      name="jdbc/eae-qs/qs"
      type="javax.sql.DataSource"
  />
</Context>
EOF
    else 
        cat >> $tomcat_base/conf/context.xml <<EOF
</Context>
EOF
    fi
}

function create_user_and_group_if_not_present()
{
   if [ $(grep $ece_user /etc/passwd | wc -l) -lt 1 ]; then
       print_and_log "Creating UNIX user $ece_user ..."
        # TODO add support for useradd
       run adduser $ece_user \
           --disabled-password \
           --gecos "Escenic-user,Room,Work,Home,Other"
       add_next_step "I created a new UNIX user called $ece_user"
       add_next_step "and you must set a password using: passwd $ece_user"
   fi
   
   if [ $(grep $ece_group /etc/group | wc -l) -lt 1 ]; then
       print_and_log "Creating UNIX group $ece_group ..."
       run addgroup $ece_group
   fi
 }

# last, give the control back to the ECE user & group 
function set_correct_permissions()
{
    print_and_log "Setting correct permissions on ECE related directories ..."

    for el in $engine_dir_list; do
        if [ ! -d $el ]; then
            continue
        fi
        
        if [ ${el} = ${escenic_data_dir} ]; then
            local correct_permission=$(find ${el} \
                -maxdepth 0 \
                -user ${ece_user} | \
                wc -l)
            if [ $correct_permission -gt 0 ]; then
                print_and_log "Data directory root, $el,"
                print_and_log "has correct permissions, skiping sub directories."
                continue
            fi
        fi

        run chown -R ${ece_user}:${ece_group} $el
    done
    
    if [ -d "$tomcat_base" ]; then
        run chown -R ${ece_user}:${ece_group} $tomcat_base
    fi

    if [ $(ls /tmp | grep ^ece | wc -l) -gt 0 ]; then
        run chown -R ${ece_user}:${ece_group} /tmp/ece-*
    fi
}

function print_status_and_next_steps()
{
    now=`date +%s`
    started=`stat -c %Y $pid_file`
    seconds=$(( now - started ))
    days=$(( seconds / ( 60 * 60 * 24 ) ))
    seconds_left=$(( seconds - ( $days * 60 * 60 * 24 ) ))
    hours=$(( seconds_left / ( 60 * 60 ) ))
    seconds_left=$(( seconds_left - ( $hours * 60 * 60 ) ))
    minutes=$(( seconds_left / 60 ))
    seconds_left=$(( seconds_left - $minutes * 60 ))

    if [ $install_profile_number -ne $PROFILE_RESTORE_FROM_BACKUP ]; then
        s="The installation is now complete!"
    else
        s="The restore is now complete!"
    fi
    print_and_log $s" It took" ${days}d ${hours}h ${minutes}m ${seconds_left}s

    if [ $install_profile_number -ne $PROFILE_RESTORE_FROM_BACKUP -a \
        $install_profile_number -ne $PROFILE_CACHE_SERVER -a \
        $install_profile_number -ne $PROFILE_WIDGET_FRAMEWORK ]; then
        add_next_step "Install info: "\ "/usr/share/doc/escenic/ece-install-guide.txt"
        add_next_step "Guide books: http://documentation.vizrt.com/ece-5.3.html"
    fi
    
    for (( i = 0; i < ${#next_steps[@]}; i++ )); do
        print "  - " ${next_steps[$i]}
    done

    print $'\n'"Enjoy your time with Escenic Content Engine!"$'\n'
    print "-Vizrt Online"
}

# Based on Erik Mogensen's work:
# //depot/branches/personal/mogsie/fromscratch/create-publication.sh
function create_publication_in_db()
{
    print_and_log "Creating ${publication_name} using $instance_name ..."

    ece_admin_uri=http://$HOSTNAME:${appserver_port}/escenic-admin
    
    cookie=$(curl ${curl_opts} -I ${ece_admin_uri}/ | \
        grep -i "^Set-Cookie" | \
        sed s/.*'JSESSIONID=\([^;]*\).*'/'\1'/)

    if [ "$cookie" == "" ] ; then
        print_and_log "Unable to get a session cookie."
        remove_pid_and_exit_in_error;
    fi

    run curl ${curl_opts} \
        -F "type=webapp" \
        -F "resourceFile=@${1}" \
        --cookie JSESSIONID="$cookie" \
        "${ece_admin_uri}/do/publication/resource"
    
    run curl ${curl_opts}  \
        -F "name=${publication_name}" \
        -F "publisherName=Escenic" \
        -F "adminPassword=${publication_name}" \
        -F "adminPasswordConfirm=${publication_name}" \
        --cookie JSESSIONID="$cookie" \
        "${ece_admin_uri}/do/publication/insert"
}

function create_publication_definition_and_war()
{
    publication_name=mypub

    if [ $fai_enabled -eq 0 ]; then
        print "What name do you wish to give your publication?"
        print "Press ENTER to accept ${publication_name}"
        echo -n "Your choice [${publication_name}]> "
        read publication_name
    else
        publication_name=$(get_conf_value fai_publication_name)
    fi

    if [ -z "$publication_name" ]; then
        publication_name=mypub
    fi

    print_and_log "Setting up the ${publication_name} publication ..."
    make_dir $escenic_root_dir/assemblytool/publications/
    run cd $escenic_root_dir/assemblytool/publications/
    cat > $escenic_root_dir/assemblytool/publications/${publication_name}.properties <<EOF
name: ${publication_name}
source-war: ${publication_name}.war
context-root: ${publication_name}
EOF

    publication_war=$escenic_root_dir/assemblytool/publications/${publication_name}.war
    if [[ $fai_enabled -eq 1 && -n "${fai_publication_war}" ]]; then
        print_and_log "Basing ${publication_name}.war on the one specified in $conf_file"
        run cp ${fai_publication_war} ${publication_war}
    elif [ -d $escenic_root_dir/widget-framework-core-* ]; then
        print_and_log "Basing ${publication_name}.war on Widget Framework Demo ..."
        run cd $escenic_root_dir/widget-framework-core-*/publications/demo-core
        run mvn $maven_opts package
        run cp target/demo-core-*.war ${publication_war}
    else
        print_and_log "Basing your ${publication_name}.war on ECE/demo-clean ..."
        run cp $escenic_root_dir/engine/contrib/wars/demo-clean.war ${publication_war}
    fi

    # TODO add support for the community widgets
    #
    # 1 - add the core widgets to the
    # publications/demo-community/pom.xml
    # 
    # 2 - add the <ui:group name="core-widgets"/> definition for core
    # widgets in:
    # publications/demo-community/src/main/webapp/META-INF/escenic/publication-resources/escenic/content-type
}

function check_for_required_downloads()
{
    if [ $ece_software_setup_completed -eq 1 ]; then
        return
    fi
    
    print_and_log "Asserting that required downloads succeeded ..."
    required_escenic_packages="engine assemblytool"

    for el in $required_escenic_packages; do
        if [ $(ls $download_dir | \
            grep ${el} | \
            grep -v community | \
            grep -v analysis | \
            grep .zip$ | \
            wc -l) \
            -lt 1 ]; then
            print_and_log "Couldn't find $el* in $download_dir"
            remove_pid_and_exit_in_error
        fi
    done
}

function install_memcached()
{
    if [ $on_debian_or_derivative ]; then
        install_packages_if_missing "memcached"
    fi
    
     # 1) download java library
     # 2) configure PresenationArticle cache for the publication
     # 3) build and re-deploy
    
    cat >> $escenic_conf_dir/engine/common/Initial.properties <<EOF

# using memcached
service.0.0-memcached-socket-pool=/com/danga/SockIOPool
EOF

    echo "TBD"
}

function set_up_user_enviornment()
{
    print_and_log "Setting up the ${ece_user} user's UNIX environment ..."

    local bashrc=/home/${ece_user}/.bashrc
    if [ $(uname -s) = "Darwin" ]; then
        bashrc=/Users/${ece_user}/.bashrc
    fi
    
    if [ $(grep bash_completion.d/ece ${bashrc}  2>/dev/null | \
        wc -l) -lt 1 ]; then
        echo ". /etc/bash_completion.d/ece" >> ${bashrc}
    fi

    if [ $(grep ECE_CONF_LOCATIONS ${bashrc} | wc -l) -eq 0 ]; then
        echo "export ECE_CONF_LOCATIONS=\"$escenic_conf_dir\"" >> ${bashrc}
        run chown ${ece_user}:${ece_group} ${bashrc}
    fi
}

function set_up_solr()
{
    run_hook set_up_solr.preinst
    
    print_and_log "Setting up solr ..."
    if [ ! -d $escenic_conf_dir/solr ]; then
        if [ $(is_using_conf_archive) -eq 1 ]; then
            print_and_log "Using the supplied Solr configuration from" 
            print_and_log "bundle: $ece_instance_conf_archive"
            local a_tmp_dir=$(mktemp -d)
            run cd $a_tmp_dir
            run tar xzf $ece_instance_conf_archive engine/solr/conf
            run cp -r engine/solr/conf $escenic_conf_dir/solr
            run rm -r $a_tmp_dir
        else
            print_and_log "Installing default Solr conf shipped with ECE ..."
            run cp -r $escenic_root_dir/engine/solr/conf $escenic_conf_dir/solr
        fi
    else
        print_and_log "$escenic_conf_dir/solr already exists, not touching it."
    fi

    make_dir $escenic_data_dir/solr/
    run cd $escenic_data_dir/solr/
    if  [ ! -h conf ]; then
        run ln -s $escenic_conf_dir/solr conf
    fi

    local editorial_search_instance=${fai_search_for_editor-0}
    local file=$escenic_conf_dir/solr/solrconfig.xml
    if [ $editorial_search_instance -eq 1 ]; then
        run sed -i "s#<maxTime>[0-9]*</maxTime>#<maxTime>5000</maxTime>#g" $file
    else
        run sed -i "s#<maxTime>[0-9]*</maxTime>#<maxTime>60000</maxTime>#g" $file
    fi

    run_hook set_up_solr.postinst
}

# So far, I've used this method for copy/past-ing it into the shell
# before running ece-insatll anew. It might be useful for its own
# command later, though.
function un_install_ece()
{
    print_and_log "Uninstalling ECE ..."
     # TODO safety, warnings++
    rm -rf $escenic_conf_dir/ \
        ${appserver_root_dir}/*tomcat* \
        $escenic_root_dir \
        $escenic_data_dir \
        $escenic_run_dir/ \
        $escenic_conf_dir/ \
        /usr/bin/ece \
        $escenic_log_dir/ \
        /etc/apt/sources.list.d/escenic.list \
        /var/run/ece-install.pid
#        $HOME/.m2 \

    # remove the Varnish key
    apt-key remove C4DEFFEB
    # remove the Percona key
    apt-key remove CD2EFD2A

    for el in \
        ant \
        ant-contrib \
        ant-optional \
        libmysql-java \
        maven2 \
        memcached \
        munin* \
        nginx \
        percona* \
        varnish \
        sun-java6-jdk \
        ; do
        apt-get --yes --purge remove $el
    done
    
    apt-get clean
}

## Returns the privileged hosts. This will include both the IP(s) the
## logged in user conduction the ece-install is coming from, as well
## as any IPs defined in fai_privileged_hosts.
function get_privileged_hosts()
{
    local privileged_hosts=${fai_privileged_hosts}
    
    for ip in $(
        w -h  | \
            grep pts | \
            sed "s#.*pts/[0-9]*[ ]*\(.*\)#\1#" | \
            cut -d' ' -f1 | \
            sort | \
            uniq
    ); do
        privileged_hosts=${privileged_hosts}" "${ip}
    done

    echo ${privileged_hosts}
}

function set_up_varnish()
{
    print_and_log "Setting up Varnish to match your environment ..."
    run /etc/init.d/varnish stop

    # we need to swap standard err and standard out here as varnishd
    # -V for some reason writes to standard error.
    using_varnish_3=$(varnishd -V 3>&1 1>&2 2>&3 | grep varnish-3 | wc -l)
    
    file=/etc/default/varnish
    sed -i -e 's/6081/80/g' -e 's/^START=no$/START=yes/' $file
    exit_on_error "sed on $file"

    cat > /etc/varnish/default.vcl <<EOF
/* Varnish configuration for Escenic Content Engine              -*- java -*- */

/* IPs that are allowed to access the administrative pages/webapps. */
acl staff {
  "localhost";
EOF
    for l in $(get_privileged_hosts); do
        cat >> /etc/varnish/default.vcl <<EOF
  # Privileged host (either doing the ece-install or listed as such)
  "${l}";
EOF
    done
    
    cat >> /etc/varnish/default.vcl <<EOF
}

/* The IP of the Adactus/Mobilize server */
acl adactus {
  "203.33.232.216";
}

/* Our web server for serving static content */
backend static {
  .host = "localhost";
  .port = "81";
}
EOF
    for el in $backend_servers; do
        appserver_id=$(echo $el | cut -d':' -f1 | sed 's/-/_/g')
        appserver_host=$(echo $el | cut -d':' -f1)
        appserver_port=$(echo $el | cut -d':' -f2)

        cat >> /etc/varnish/default.vcl <<EOF
backend $appserver_id {
  .host = "$appserver_host";
  .port = "$appserver_port";
}

EOF
    done

    cat >> /etc/varnish/default.vcl <<EOF
/* The client director gives us session stickiness based on client
 * IP. */
director webdirector client {
EOF
    for el in $backend_servers; do
	      appserver_id=$(echo $el | cut -d':' -f1 | sed 's/-/_/g' )        
        cat >> /etc/varnish/default.vcl <<EOF
  {
     .backend = $appserver_id;
     .weight = 1;
  }
EOF
    done

    cat >> /etc/varnish/default.vcl <<EOF
}
EOF

    cat >> /etc/varnish/default.vcl <<EOF
sub vcl_recv {
  if (!client.ip ~ staff &&
      (req.url ~ "^/escenic" ||
       req.url ~ "^/studio" ||
       req.url ~ "^/munin" ||
       req.url ~ "^/webservice" ||
       req.url ~ "^/escenic-admin")) {
     error 405 "Not allowed.";
  }

  /* Only Adactus/Mobilize is allowed to access the /binary context
   * which contains all the full quality video files. */
  if (!client.ip ~ adactus && req.url ~ "^/binary") {
    error 405 "Not allowed.";
  }

  if (req.url ~ "^/munin") {
    set req.url = regsub(req.url, "^/munin", "/");
    set req.backend = static;
  }
  else {
    set req.backend = webdirector;
  }

  if (req.url ~ "\.(png|gif|jpg|css|js)$" || req.url == "/favicon.ico") { 
    remove req.http.Cookie;
  }
}

 /* Called when content is fetched from the backend. */
sub vcl_fetch {
  /* Remove cookies from these resource types and cache them for a
   * long time */
  if (req.url ~ "\.(png|gif|jpg|css|js)$" || req.url == "/favicon.ico") { 
    set beresp.ttl = 5h;
    remove beresp.http.Set-Cookie;
  }
}

sub vcl_deliver {
  /* Adds debug header to the result so that we can easily see if a
   * URL has been fetched from cache or not.
   */
  if (obj.hits > 0) {
EOF
    if [ $using_varnish_3 -gt 0 ]; then
        cat >> /etc/varnish/default.vcl <<EOF
    set resp.http.X-Cache = "HIT #" + obj.hits;
EOF
    else
        cat >> /etc/varnish/default.vcl <<EOF
    set resp.http.X-Cache = "HIT #" obj.hits;
EOF
    fi
    
    cat >> /etc/varnish/default.vcl <<EOF
  }
  else {
    set resp.http.X-Cache = "MISS";
  }

  set resp.http.X-Cache-Backend = req.backend;
}
EOF
    run /etc/init.d/varnish start
}

function read_user_input()
{
    installation_profiles=(
      "$PROFILE_ALL_IN_ONE - All in one, full stack on one host,"\
" suitable for dev & test environments"
      "$PROFILE_EDITORIAL_SERVER - Editorial (publication) server"
      "$PROFILE_PRESENTATION_SERVER - Presentation server (ECE + memcached)."
      "$PROFILE_DB_SERVER - Database server"
      "$PROFILE_CACHE_SERVER - Cache server (cache and web server)"
      "$PROFILE_RMI_HUB - RMI hub"
      "$PROFILE_SEARCH_SERVER - Search server (Solr + indexer-webapp)"
      "$PROFILE_WIDGET_FRAMEWORK - Install Widget Framework."
      "$PROFILE_CREATE_PUBLICATION - Create a new publication"\
" based on WF if available, ECE/clean-demo if not"
      "$PROFILE_MONITORING_SERVER - A monitoring server (web server +"\
" Munin gatherer)"
      "$PROFILE_RESTORE_FROM_BACKUP - Restore from backup"\
" (DB, data files, binaries, conf & publications)"
    )
    
    echo "Hi, which server profile do you wish to install?"$'\n'

    for (( i = 0; i < ${#installation_profiles[@]}; i++ )); do
        echo "  " ${installation_profiles[$i]}
    done

    echo $'\n'"Select 1-${#installation_profiles[@]} and press ENTER"
    echo -n "Your choice [1]> "
    read install_profile_number
    
    if [ -z "$install_profile_number" ]; then
        install_profile_number=$PROFILE_ALL_IN_ONE
    fi

    if [ $(is_number $install_profile_number) -eq 0 ]; then
        print_and_log "Profile number, $install_profile_number, is not a number"
        remove_pid_and_exit_in_error
    fi
}

function assert_correct_runtime_environment()
{
    if [ $(whoami) != "root" ]; then
        print "You must be root when running $(basename $0)"
        exit 1
    fi
    
    if [ -e $pid_file ]; then
        print "There's already one $(basename $0) process running."
        print "If you blelieve this is wrong, e.g. if a previous run of" 
        print "$(basename $0) was aborted before it completed, you"
        print "may remove ${pid_file} and run $(basename $0) again."
        exit 1
    else
        echo $BASHPID > $pid_file
        started=`stat -c %Y $pid_file`
    fi

    if [ ! -e "$conf_file" ]; then
        print $conf_file "doesn't exist."
        print "I cannot live without it, so I'm exiting :-("
        remove_pid_and_exit_in_error
    fi
}

function common_pre_install()
{
    print "I'm logging to $log"

    run source $conf_file

    # These variables are placed here as all the directories can be
    # overridden in ece-install.conf
    common_nursery_dir=$escenic_conf_dir/engine/common
    
    # Because of issue VF-3559, we also
    # create the default family and host directories.
    engine_dir_list="
      $common_nursery_dir
      $escenic_conf_dir/engine/family/default
      $escenic_conf_dir/engine/host/localhost
      $escenic_root_dir
      $escenic_cache_dir
      $escenic_crash_dir
      $escenic_data_dir
      $escenic_data_dir/solr/data
      $escenic_log_dir
      $escenic_run_dir
      $escenic_spool_dir/migration
    "
    ece_install_env=${escenic_run_dir}/$(basename $0).env

    if [ -z "$technet_user" -o -z "$technet_password" ]; then
        print_and_log "Be sure to set technet_user and technet_password "
        print_and_log "in $conf_file"
        remove_pid_and_exit_in_error
    fi

    if [ -e /etc/debian_version -a -x /usr/bin/dpkg ]; then
        on_debian_or_derivative=1
        export DEBIAN_FRONTEND=noninteractive
    fi

    # chicken and the egg problem, we need lsb_release to install the
    # packages later on, hence as soon as we know we've got a Debian
    # based platform, we install lsb-release. Also note, the
    # executable, lsb_release, is in the list of required binaries in
    # install_common_os_packages.
    install_packages_if_missing "lsb-release"
    
    if [ $(lsb_release -i | grep Ubuntu | wc -l) -gt 0 ]; then
        on_ubuntu=1
    elif [ $(lsb_release -i | grep Debian | wc -l) -gt 0 ]; then
        on_debian=1
    fi

    make_dir $download_dir
    install_common_os_packages
    create_user_and_group_if_not_present
    set_up_user_enviornment
}

function assert_pre_prequesite()
{
    if [ $(which $1 | wc -l) -lt 1 ]; then
        print_and_log "Please install $1 and then run $(basename $0) again."
        remove_pid_and_exit_in_error
    fi
}

function add_apt_source()
{
    escenic_sources=/etc/apt/sources.list.d/escenic.list
    if [ ! -e $escenic_sources ]; then
        echo "$@" >> $escenic_sources
        run apt-get update
    elif [ $(grep "$@" $escenic_sources | wc -l) -lt 1 ]; then
        echo "$@" >> $escenic_sources
        run apt-get update
    fi
}

function install_cache_server()
{
    print_and_log "Installing a caching server on $HOSTNAME ..."

    if [ $on_debian_or_derivative -eq 1 ]; then
        curl ${curl_opts} \
            http://repo.varnish-cache.org/debian/GPG-key.txt \
            2>> $log | \
            apt-key add - \
            1>>$log 2>>$log
        run apt-get update
    fi

    code_name=$(lsb_release -s -c)
        
    supported_code_name=0
    # list taken from http://repo.varnish-cache.org/debian/dists/
    supported_list="lenny squeeze hardy lucid"
    for el in $supported_list; do
        if [ $code_name = $el ]; then
            supported_code_name=1
        fi
    done
    
    if [ $supported_code_name -eq 1 -a $on_debian -eq 1 ]; then
        add_apt_source "deb http://repo.varnish-cache.org/debian/ $(lsb_release -s -c) varnish-3.0"
    elif [ $supported_code_name -eq 1 -a $on_ubuntu -eq 1 ]; then
        add_apt_source "deb http://repo.varnish-cache.org/ubuntu/ $(lsb_release -s -c) varnish-3.0"
    fi

    if [ $on_debian_or_derivative -eq 1 ]; then
        apt-get -y install varnish 1>>$log 2>>$log
    fi

    assert_pre_prequesite varnishd

    if [ $fai_enabled -eq 0 ]; then
        print "You must now list your backend servers."
        print "Seperate the entries with a space. e.g.: app1:8080 app2:8080."
        print "Press ENTER to accept the default: ${HOSTNAME}:${appserver_port}"
        echo -n "Your choice [${HOSTNAME}:${appserver_port}]> "
        read backend_servers
    else
        backend_servers=$(get_conf_value fai_cache_backends)
    fi

    if [ -z "$backend_servers" ]; then
        backend_servers="${HOSTNAME}:${appserver_port}"
    fi

    set_up_varnish $backend_servers

    add_next_step "Cache server is up and running at http://${HOSTNAME}:80/"
}

# Parameters:
# $1 : your added line
function add_next_step()
{
    next_steps[${#next_steps[@]}]="${1}"
    return
    
    if [ -n "$next_steps" ]; then
        next_steps=${next_steps}${NEW_LINE}"[$(basename $0)] "${1}
    else
         next_steps="[$(basename $0)] "${1}
    fi
}

# $1 : optional parameter, binaries_only. If passed, $1=binaries_only,
#      the ECE DB schema is not set up. 
function install_database_server()
{
    print_and_log "Installing the database server on $HOSTNAME ..."

    source /usr/sbin/drop-and-create-ecedb

    if [ $on_debian_or_derivative -eq 1 ]; then

        code_name=$(lsb_release -s -c)
        
        supported_code_name=0
        supported_list="lenny squeeze hardy lucid maverick"
        for el in $supported_list; do
            if [ $code_name = $el ]; then
                supported_code_name=1
            fi
        done
        
         # some how, this is to install Percona 5.5
        if [ -e /var/lib/mysql/debian-*.flag ]; then
            run rm /var/lib/mysql/debian-*.flag
        fi
        
        if [ $supported_code_name -eq 1 ]; then
            print_and_log "Installing the Percona database ..."

            if [ $(apt-key list| grep CD2EFD2A | wc -l) -lt 1 ]; then
                run gpg --keyserver hkp://keys.gnupg.net \
                    --recv-keys 1C4CBDCDCD2EFD2A
                
                # There has been twice now, during six months, that
                # the key cannot be retrieved from
                # keys.gnupg.net. Therefore, we're checking if it
                # failed and if yes, force the package installation.
                if [ $? -gt 0 ]; then
                    s="Failed retrieving the Percona key from keys.gnupg.net"
                    print_and_log $s
                    s="Will install the Percona packages without the GPG key"
                    print_and_log $s
                    force_packages=1
                else
                    gpg --armor \
                        -a \
                        --export 1C4CBDCDCD2EFD2A | \
                        apt-key add - \
                        1>>$log 2>>$log
                fi

                run apt-get update
            fi
            
            add_apt_source "deb http://repo.percona.com/apt ${code_name} main"
            packages="percona-server-server percona-server-client"
            install_packages_if_missing $packages
            force_packages=0
        else
            print_and_log "The Percona APT repsository doesn't have packages" 
            print_and_log "for your Debian (or derivative) version with code"
            print_and_log "name $code_name. "
            print_and_log "I will use vanilla MySQL instead."

            packages="mysql-server mysql-client"
            install_packages_if_missing $packages
        fi
    fi

    assert_pre_prequesite mysql

    if [ -z "$1" ]; then
        download_escenic_components
        set_up_engine_and_plugins
        set_up_ecedb
    fi
}

# $1 is the default instance name, the calee is responsible for
# setting this.
function ask_for_instance_name()
{
    if [ $fai_enabled -eq 0 ]; then
        print "What do you want to call this ECE instance?"
        print "Press ENTER to accept the default instance name, $1."
        echo -n "Your choice [$1]> "
        read instance_name
    else
        if [ $install_profile_number -eq $PROFILE_EDITORIAL_SERVER ]; then
            instance_name=${fai_editor_name-$1}
        elif [ $install_profile_number -eq $PROFILE_PRESENTATION_SERVER ]; then
            instance_name=${fai_presentation_name-$1}
        elif [ $install_profile_number -eq $PROFILE_SEARCH_SERVER ]; then
            instance_name=${fai_search_name-$1}
        elif [ $install_profile_number -eq $PROFILE_ANALYSIS_SERVER ]; then
            instance_name=${fai_analysis_name-$1}
        fi
    fi

    if [ -z "$instance_name" ]; then
        instance_name=$1
    fi
    make_dir $escenic_conf_dir/engine/instance/${instance_name}
}

# Will update /etc/default/instance with the type instances which are
# installed on the given host. This method should work for engine,
# search and analysis instances.
function update_type_instances_to_start_up()
{
    if [ $type = "engine" ]; then
        for el in $escenic_conf_dir/ece-*.conf; do
            if [ $(echo el | grep analysis | wc -l) -gt 0 ]; then
                continue
            elif [ $(echo el | grep search | wc -l) -gt 0 ]; then
                continue
            fi

            current_instance=$(basename ${el} | \
                sed -e 's/ece-//g' -e 's/engine-//g' | \
                cut -d'.' -f1)
            all_instances="$all_instances $current_instance"

            set_conf_file_value engine_instance_list \
                "$all_instances" \
                /etc/default/ece
        done
    elif [ $type = "search" ]; then
        for el in $escenic_conf_dir/ece-*.conf; do
            if [ $(echo el | grep search | wc -l) -lt 1 ]; then
                continue
            fi

            current_instance=$(basename ${el} | \
                sed -e 's/ece-//g' -e 's/search-//g' | \
                cut -d'.' -f1)
            all_instances="$all_instances $current_instance"

            set_conf_file_value search_instance_list \
                "$all_instances" \
                /etc/default/ece
        done
    fi
}

ece_instance_ear_file=""
ece_instance_conf_archive=""

function set_archive_files_depending_on_profile()
{
    if [ $install_profile_number -eq $PROFILE_PRESENTATION_SERVER ]; then
        ece_instance_ear_file=$fai_presentation_ear
        ece_instance_conf_archive=$fai_presentation_conf_archive
    elif [ $install_profile_number -eq $PROFILE_EDITORIAL_SERVER ]; then
        ece_instance_ear_file=$fai_editor_ear
        ece_instance_conf_archive=$fai_editor_conf_archive
    elif [ $install_profile_number -eq $PROFILE_SEARCH_SERVER ]; then
        ece_instance_ear_file=$fai_search_ear
        ece_instance_conf_archive=$fai_search_conf_archive
    fi
}


# Returns 1 if we're installing the ECE instances from a provided EAR
# file
function is_installing_from_ear()
{
    log install_profile_number=$install_profile_number
    log ece_instance_ear_file=$ece_instance_ear_file

    if [[ -z "$ece_instance_ear_file" || \
        $fai_enabled -eq 0 ]]; then
        echo 0
        return
    fi

    echo 1
}

# Returns 1 if we're using a tarball with the Nursery & JAAS configuration.
function is_using_conf_archive(){
    log install_profile_number=$install_profile_number
    log ece_instance_conf_archive=$ece_instance_conf_archive

    if [[ -z "$ece_instance_conf_archive" || \
        $fai_enabled -eq 0 ]]; then
        echo 0
        return
    fi

    echo 1
}

# verifies that the passed file(s) exist and are readable, depends on
# set_archive_files_depending_on_profile
function verify_that_files_exist_and_are_readable()
{
    debug "Verifying that the file(s) exist(s) and are readable: $@"
    
    for el in $@; do
        if [ ! -e $el ]; then
            print_and_log "The file" $el "doesn't exist. I will exit now."
            remove_pid_and_exit_in_error
        elif [ ! -r $el ]; then
            print_and_log "The file" $el "isn't readable. I will exit now."
            remove_pid_and_exit_in_error
        fi
    done
}   
        
# $1=<default instance name>
# $2=<editorial server=0 | presentation server=1>
function install_ece_instance()
{
    install_ece_third_party_packages
    
    ask_for_instance_name $1
    set_up_engine_directories
    set_up_ece_scripts

    set_archive_files_depending_on_profile
    
    # most likely, the user is _not_ installing from archives (EAR +
    # configuration bundle), hence the false test goes first.
    if [ $(is_installing_from_ear) -eq 0 ]; then
        download_escenic_components
        check_for_required_downloads
        set_up_engine_and_plugins
        set_up_assembly_tool
    else
        verify_that_files_exist_and_are_readable \
            $ece_instance_ear_file \
            $ece_instance_conf_archive
    fi
    
    set_up_basic_nursery_configuration
    set_up_instance_specific_nursery_configuration
    
    set_up_app_server
    set_up_proper_logging_configuration

    # We set a WAR white list for all profiles except all in one
    if [ $install_profile_number -ne $PROFILE_ALL_IN_ONE ]; then
        file=$escenic_conf_dir/ece-${instance_name}.conf
        print_and_log "Creating deployment white list in $file ..."
        set_conf_file_value \
            deploy_webapp_white_list \
            $(get_deploy_white_list) \
            $file
    fi

    if [ $install_profile_number -ne $PROFILE_ANALYSIS_SERVER -a \
        $install_profile_number -ne $PROFILE_SEARCH_SERVER ]; then
        assemble_deploy_and_restart_type
    fi
    
    update_type_instances_to_start_up
    set_conf_file_value ece_unix_user $ece_user /etc/default/ece
    set_conf_file_value ece_unix_group $ece_group /etc/default/ece

    admin_uri=http://$HOSTNAME:${appserver_port}/escenic-admin/
    add_next_step "New ECE instance $instance_name installed."
    add_next_step "Admin interface: $admin_uri"
    add_next_step "View installed versions with:"\
" ece -i $instance_name versions"
    add_next_step "Type 'ece help' to see all the options of this script"
    add_next_step "Read its guide: /usr/share/doc/escenic/ece-guide.txt"
    add_next_step "/etc/default/ece lists all instances started at boot time"
}

function get_publication_short_name_list()
{
    local short_name_list=""
    
    local publication_def_dir=${escenic_root_dir}/assemblytool/publications
    if [ $(ls ${publication_def_dir} | grep .properties$ | wc -l) -eq 0 ]; then
        echo ${short_name_list}
        return
    fi

    for el in $(find ${publication_def_dir} -name "*.properties"); do
        local short_name=$(basename $el .properties)
        short_name_list="${short_name_list} ${short_name}"
    done

    echo ${short_name_list}
 }

function get_deploy_white_list()
{
    local white_list="escenic-admin"
    
    if [ $install_profile_number -eq $PROFILE_PRESENTATION_SERVER \
        -a -n "${publication_name}" ]; then
        white_list="${white_list} ${publication_name} "
    elif [ $install_profile_number -eq $PROFILE_SEARCH_SERVER ]; then 
        white_list="${white_list} solr indexer-webapp"
    elif [ $install_profile_number -eq $PROFILE_PRESENTATION_SERVER ]; then
        white_list="${white_list} "$(get_publication_short_name_list)
    elif [ $install_profile_number -eq $PROFILE_EDITORIAL_SERVER ]; then
        white_list="${white_list} escenic studio indexer-webservice"
        white_list="${white_list} "$(get_publication_short_name_list)
    fi

    echo ${white_list}
}

function install_presentation_server()
{
    print_and_log "Installing a presentation server on $HOSTNAME ..."
    type=engine
    install_ece_instance "web1" $PROFILE_PRESENTATION_SERVER
}

function assemble_deploy_and_restart_type()
{
    print_and_log "Assembling, deploying & starting $instance_name ..."
    
    set_correct_permissions

    # need to run clean here since we might be running multiple
    # profiles in the same ece-install process.
    ece_command="ece -i $instance_name -t $type clean assemble deploy restart"
    if [ $(is_installing_from_ear) -eq 1 ]; then
        run cp $ece_instance_ear_file $escenic_cache_dir/engine.ear
        ece_command="ece -i $instance_name -t $type deploy restart"
        print_and_log "Using the supplied EAR instead of running an assembly."
    fi
    
    su - $ece_user -c "$ece_command" 1>>$log 2>>$log
    exit_on_error "su - $ece_user -c \"$ece_command\""
}

function ensure_that_instance_is_running()
{
    ece_command="ece -i $1 -t $type status"
    if [ $(su - $ece_user -c "$ece_command" | grep UP | wc -l) -lt 1 ]; then
        ece_command="ece -i $1 -t $type start"
        su - $ece_user -c "$ece_command" 1>>$log 2>>$log
        # TODO improve this by adding a timed while loop
        sleep 60
    fi
}

# If the system is installed using the recommended paths, the method
# will return a list of the instances configured in
# ${escenic_conf_dir}/engine/instance
function get_instance_list()
{
    local instance_list=""

    if [ -r ${escenic_conf_dir}/engine/instance ]; then
        instance_list=$(ls ${escenic_conf_dir}/engine/instance)
    fi

    echo $instance_list
}

function create_publication()
{
    if [ ! -e $escenic_root_dir/engine -o \
        ! -e $escenic_root_dir/assemblytool ]; then
        print_and_log "Please install ECE and an assembly environment before"
        print_and_log "running this installation profile again."
        remove_pid_and_exit_in_error
    fi

    print_and_log "Getting ready to create a new publication ..."
    create_publication_definition_and_war

    local instance_list=$(get_instance_list)
    local default_instance=$(echo ${instance_list} | cut -d' ' -f1)

    if [ $fai_enabled -eq 0 ]; then
        print "Which ECE instance do you wish to use to create it?"
        print "These instances are available: $instance_list"
        echo -n "Your choice [$default_instance]> "
        read instance_name
    else
        instance_name=$(get_conf_value fai_publication_use_instance)
    fi

    if [ -z "$instance_name" ]; then
        instance_name=$default_instance
    fi

    type=engine
    ensure_that_instance_is_running $instance_name
    create_publication_in_db $publication_war
    assemble_deploy_and_restart_type

    add_next_step "A new publication $publication_name has been created."
}

function install_editorial_server()
{
    print_and_log "Installing an editorial server on $HOSTNAME ..."
    type=engine
    install_ece_instance "editor1" 0
}

function run_hook()
{
    if [ -e $ece_install_scripts_dir -a \
        -e ${ece_install_scripts_dir}/${1} ]; then

        # Dumping all set variables (no functions) to a file from
        # which the hooks can pick them up. We do this to avoid
        # running "export" in front of all local variables which may
        # or may not be useful. Furthermore, we filter out upper case
        # variables as these are environment variables.
        set | grep ^[a-z] | grep \= > ${ece_install_env}
        
        print_and_log "Started hook  $1 ..."
        bash ${ece_install_scripts_dir}/${1}
        print_and_log "Finished hook $1 ..."
    fi
}

function install_analysis_server()
{
    run_hook install_analysis_server.preinst
    
    print_and_log "Installing an analysis server on $HOSTNAME ..."
    type=analysis
    
    install_ece_instance "analysis1"

    run cp ${escenic_root_dir}/analysis-engine-*/wars/*.war \
        ${tomcat_base}/webapps

    if [ -n "${fai_analysis_host}" ]; then
        appserver_host=${fai_analysis_host}
    fi
    if [ -n "${fai_analysis_port}" ]; then
        appserver_port=${fai_analysis_port}
    fi
    
    # deploy the EAE WARs
    run cp ${escenic_root_dir}/analysis-engine-*/wars/*.war \
        ${tomcat_base}/webapps

    set_correct_permissions
    
    local ece_command="ece -i ${instance_name} -t ${type} start"
    su - $ece_user -c "$ece_command" 1>>$log 2>>$log
    exit_on_error "su - $ece_user -c \"$ece_command\""

    local seconds=3
    print_and_log "Waiting ${seconds} seconds for EAE to come up ..."
    sleep 10
    
    # EAE cannot handle .cfg files with quotes values (!)
    dont_quote_conf_values=1
    
    print_and_log "Configuring EAE Reports ..."
    local file=${tomcat_base}/webapps/analysis-reports/WEB-INF/config/reports.cfg
    set_conf_file_value queryServiceUrl \
        http://${appserver_host}:${appserver_port}/analysis-qs/QueryService \
        ${file}

    print_and_log "Configuring EAE Logger ..."
    local file=${tomcat_base}/webapps/analysis-logger/WEB-INF/config/logger.cfg
    set_conf_file_value databaseQueueManager.reinsertcount \
        6 \
        ${file}
    set_conf_file_value pageview.maintenance.cron.expr '0 0 4 * * ? *' $file
    set_conf_file_value pageview.aggr.hour.cron.expr '0 10 * * * ?' $file
    set_conf_file_value imageResponse false $file
    set_conf_file_value pageview.maintenance.older.than.months 6 $file
    set_conf_file_value pageview.aggr.day.older.than.days 7 $file
    set_conf_file_value pageview.aggr.day.cron.expr '0 0 5 * * ? *' $file
    set_conf_file_value pageview.aggr.hour.older.than.hours 2 $file
    set_conf_file_value pageview.maintenance.older.than.days 0 $file

    # important to turn this off here, it's only for the EAE .cfg
    # files, see above.
    dont_quote_conf_values=0

    # touching web.xml to trigger a re-deploy of the EAE Reports
    # application.
    run touch ${tomcat_base}/webapps/analysis-reports/WEB-INF/web.xml
    run_hook install_analysis_server.postinst
}

function install_rmi_hub()
{
    make_dir $escenic_conf_dir/rmi-hub
    
    run cp -r $escenic_root_dir/engine/contrib/rmi-hub/config/* \
        $escenic_conf_dir/rmi-hub/

    hub_host=$HOSTNAME
    file=$common_nursery_dir
    file=$file/neo/io/managers/HubConnectionManager.properties

    make_dir $(basename $file)
    set_conf_file_value hub \
        "rmi://${hub_host}:1099/hub/Hub" \
        $file

    cat > $common_nursery_dir/io/api/EventManager.properties <<EOF
clientConfiguration=/neo/io/services/HubConnection
pingTime=10000
EOF

    add_next_step "Restart all your instances to make the hub see them."

    print_and_log "Starting the RMI-hub on $HOSTNAME ..."
    ece_command="ece -t rmi-hub restart"
    su - $ece_user -c "$ece_command" 1>>$log 2>>$log
}

# reads the value of the desired setting from $conf_file
#
# parameters: $1 : the conf key, see ece-install-guide.txt for an
# overview of the available keys.
function get_conf_value()
{
    if [ ! -e "$conf_file" ]; then
        print_and_log $conf_file "doesn't exist."
        remove_pid_and_exit_in_error
    fi

    if [ $(grep $1 $conf_file | grep -v ^# | wc -l) -gt 0 ]; then
        echo $(grep $1 $conf_file | grep -v ^# | cut -d'=' -f2)
    fi
}

# returns 0 for false, 1 for true
#
# parameters: $1 : the conf key, see get_conf_value
function get_boolean_conf_value()
{
    value=$(get_conf_value $1)
    if [ -z "$value" ]; then
        echo 0
    elif [ "$value" = "" ]; then
        echo 0
    elif [ "$value" -eq 1 ]; then
        echo 1
    else
        echo 0
    fi
}

function install_widget_framework()
{
    print_and_log "Installing Widget Framework on $HOSTNAME ..."
    # TODO java.lang.NoClassDefFoundError:
    # Lcom/escenic/framework/captcha/ReCaptchaConfig;
    
    wf_user=$(get_conf_value wf_user)
    wf_password=$(get_conf_value wf_password)

    if [ -z "$wf_user" -o -z "$wf_password" ]; then
        print_and_log "Missing wf_user and wf_password in ${conf_file}. If you"
        print_and_log "don't have these, please contact support@escenic.com"
        remove_pid_and_exit_in_error
    fi

    print_and_log "Creating a Maven settings file: $HOME/.m2/settings.xml ..."
    make_dir $HOME/.m2
    cat > $HOME/.m2/settings.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/settings/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                              http://maven.apache.org/xsd/settings-1.0.0.xsd">
  <servers>
    <server>
      <id>escenic-repo</id>
      <username>${wf_user}</username>
      <password>${wf_password}</password>
    </server>
  </servers>

  <profiles>
    <profile>
      <id>escenic-profile</id>
      <repositories>
        <repository>
          <id>escenic-repo</id>
          <name>Repository for EWF libraries</name>
          <url>http://repo.escenic.com/</url>
          <layout>default</layout>
        </repository>
      </repositories>
    </profile>
  </profiles>

  <activeProfiles>
    <activeProfile>escenic-profile</activeProfile>
  </activeProfiles>
</settings>
EOF

    print_and_log "Downloading Widget Framework from technet.escenic.com ..."
    for el in $wf_download_list; do
        cd $download_dir
        run wget $wget_opts \
            --http-user $technet_user \
            --http-password $technet_password \
            $el
        run cd $escenic_root_dir/
        run unzip -q -u $download_dir/$(basename $el)
    done

    assert_pre_prequesite mvn
    export JAVA_HOME=$java_home
    wf_maven_dir=$(echo $escenic_root_dir/widget-framework-core-*/maven)
    run cd $wf_maven_dir
    
    print_and_log "Installing Widget Framework into your Maven repository ..."
    log "JAVA_HOME=$JAVA_HOME"
    
    run mvn $maven_opts install

    # installing the widget-framework-common as a ECE plugin
    wf_dist_dir=$(echo $wf_maven_dir/widget-framework-common/target/widget-framework-common-*-dist/widget-framework-common-*)
    cd $escenic_root_dir/assemblytool/plugins
    if [ ! -h $(basename $wf_dist_dir) ]; then
        ln -s $wf_dist_dir
    fi
    
    cp -r $wf_dist_dir/misc/siteconfig/* $common_nursery_dir/

    add_next_step "Widget Framework has been installed into your "\
" Maven repo"
}

function install_search_server()
{
    print_and_log "Installing a search server on $HOSTNAME ..."
    type=search
    install_ece_instance "search1" 0
    
    # TODO update instead of append
    dir=$common_nursery_dir/com/escenic/framework/search/solr
    make_dir $dir
    echo "solrServerURI=http://${search_host}:${search_port}/solr" \
        >>  $dir/SolrSearchEngine.properties
    
    dir=$common_nursery_dir/com/escenic/webservice/search
    make_dir $dir
    echo "solrURI=http://${search_host}:${search_port}/solr/select" \
        >> $dir/DelegatingSearchEngine.properties

    dir=$common_nursery_dir/com/escenic/lucy
    make_dir $dir
    echo "solrURI=http://${search_host}:${search_port}/solr" \
        >> $dir/LucySearchEngine.properties

    dir=$common_nursery_dir/com/escenic/forum/search/lucy
    make_dir $dir
    echo "solrURI=http://${search_host}:${search_port}/solr" \
        >> $dir/SearchEngine.properties

    set_up_solr
    assemble_deploy_and_restart_type
}

# useful for development and test environments.
function install_all_in_one_environment()
{
    print_and_log "Installing an all-in-one environment on $HOSTNAME ..."
    type=engine
    install_database_server
    install_ece_instance "dev1" 0
    install_cache_server
    install_web_server 2
    install_munin_gatherer
    set_up_solr

    install_widget_framework
    create_publication
}

# parameters:
# $1 - what kind of webserver. Available options are:
#      * 0 - cache server
#      * 1 - monitoring server
#      * 2 - both cache & monitoring server
function install_web_server()
{
    print_and_log "Installing a web server on $HOSTNAME ..."

    if [ $on_debian_or_derivative -eq 1 ]; then
        packages="nginx"
        install_packages_if_missing $packages
    else
        debug "Web server installation not supported on your system."
        return
    fi
    
    file=/etc/nginx/sites-available/default
    # in some very unusual cases, this file will not exist (can occur
    # when re-running ece-install several times).
    if [ -e $file ]; then
        run mv $file $file.orig
    fi

    if [ $1 -eq 0 ]; then
        port=81
        cat > $file <<EOF
server {
  listen ${port} default;
  access_log  /var/log/nginx/localhost.access.log;

  # Typical endpoint for Adactus/Mobilize to get the videos to
  # transcode.
  location /binary {
    root $escenic_data_dir;
    index index.html;
  }
}
EOF
    elif [ $1 -eq 1 ]; then
        port=80
        cat > $file <<EOF
server {
  listen ${port} default;
  access_log  /var/log/nginx/localhost.access.log;

  location / {
    root /var/cache/munin/www;
    index index.html;
  }
}
EOF
    elif [ $1 -eq 3 ]; then
        port=81
        cat > $file <<EOF
server {
  listen ${port} default;
  access_log  /var/log/nginx/localhost.access.log;

  location / {
    root /var/cache/munin/www;
    index index.html;
  }

  # Typical endpoint for Adactus/Mobilize to get the videos to
  # transcode.
  location /binary {
    root $escenic_data_dir;
    index index.html;
  }
}
EOF
    fi
    
    run /etc/init.d/nginx restart

    if [ $1 -eq 0 ]; then
        add_next_step "http://${HOSTNAME}:${port}/binary gives the Adactus endpoint"
    elif [ $1 -eq 1 ]; then
        add_next_step "http://${HOSTNAME}:${port}/ gives the Munin interface"
    elif [ $1 -eq 2 ]; then
        add_next_step "http://${HOSTNAME}:${port}/       gives the Munin interface"
        add_next_step "http://${HOSTNAME}:${port}/binary gives the Adactus endpoint"
    fi
}

function install_munin_gatherer()
{
    print_and_log "Installing a Munin gatherer on $HOSTNAME ..."

    if [ $on_debian_or_derivative -eq 1 ]; then
        packages="munin"
        install_packages_if_missing $packages
    else
        print_and_log "Munin gatherer installation not supported on your"
        print_and_log "system :-( You will have to install it manually."
        return
    fi

    if [ $fai_enabled -eq 0 ]; then
        print "Which nodes shall this Munin monitor gather from?"
        print "Separate your hosts with a space, e.g.: 'editor01 db01 web01'"
        echo -n "Your choice> "
        read user_munin_nodes
        
        if [ -n "$user_munin_nodes" ]; then
            node_list=$user_munin_nodes
        fi
    else
        node_list=${fai_monitoring_munin_node_list}
    fi
    
    if [ -z "$node_list" ]; then
        return
    fi

    for el in $node_list; do
        print_and_log "Adding ${el} to the Munin gatherer on ${HOSTNAME} ..."
        local file=/etc/munin/munin-conf.d/escenic.conf
        cat >> $file <<EOF
[${el}]
    address $(get_ip $el)
    use_node_name yes
EOF
    done

    # TODO add the priveleged network to the Allowed stanza (i.e. the
    # network wich will do the monitoring of the servers.
    local file=/etc/apache2/conf.d/munin
    if [ -n "$(get_privileged_hosts)" ]; then
        local privileged_hosts=$(
            echo $(get_privileged_hosts) | sed "s#\ #\\\ #g"
        )
        sed -i "s#Allow\ from\ localhost#Allow\ from\ ${privileged_hosts}\ localhost#g" \
            $file
        exit_on_error "Failed adding ${fai_privileged_hosts} to" \
            "Munin's allowed addresses."
        run /etc/init.d/apache2 reload
    fi

    add_next_step "Munin gatherer admin interface: http://${HOSTNAME}/munin"
    add_next_step "Make sure all nodes allows its IP to connect to them."
}

# will return the IP of the host name. If not found, the host name
# passed to the function will be returned.
# parameters: $1 the host name
function get_ip()
{
    ip=$(ping -c 1 $1 2>/dev/null | \
        grep "bytes from" | \
        cut -d'(' -f2 | \
        cut -d ')' -f1)
    
    if [ -z "$ip" ]; then
        echo $1
    fi

    echo $ip
}

## Installs the Nagios monitoring server.
## $1 the nagios vendor/falvour, "nagios" and "icinga" are supported.
function install_nagios_monitoring_server()
{
    print "Installing an $1 server on $HOSTNAME ..."
    local monitoring_vendor=$1
    
    if [ $on_debian_or_derivative -eq 1 ]; then
        if [[ $monitoring_vendor == $MONITORING_VENDOR_NAGIOS ]]; then
            install_packages_if_missing apache2 nagios3 nagios-nrpe-plugin
        else
            install_packages_if_missing \
                apache2 icinga nagios-nrpe-plugin icinga-doc
        fi
    fi

    if [[ $monitoring_vendor == $MONITORING_VENDOR_ICINGA ]]; then
        print "Setting user/pass for icinga admin ..."
        local file=/etc/icinga/htpasswd.users
        run htpasswd -b -c $file icingaadmin \
            ${fai_monitoring_admin_password-admin}
    fi
    
    # enable remote commands
    if [[ $monitoring_vendor == $MONITORING_VENDOR_NAGIOS ]]; then
        local file=/etc/nagios3/nagios.cfg
    else
        local file=/etc/icinga/icinga.cfg
    fi
    
    dont_quote_conf_values=1
    set_conf_file_value check_external_commands 1 $file
    dont_quote_conf_values=0

    for el in $fai_monitoring_host_list; do
        set_up_monitoring_host_def $monitoring_vendor $el
    done

    if [[ $monitoring_vendor == $MONITORING_VENDOR_NAGIOS ]]; then
        file=/etc/nagios3/conf.d/hostgroups_nagios2.cfg
    else
        file=/etc/icinga/objects/hostgroups_icinga.cfg
    fi
    
    set_up_monitoring_host_group \
        $file \
        "ece-hosts" \
        'Hosts running one or more ECE' \
        ${fai_monitoring_ece_host_list}

    set_up_monitoring_host_group \
        $file \
        "search-hosts" \
        'Hosts running search instance(s) (Solr + indexer)' \
        ${fai_monitoring_search_host_list}

    if [[ $monitoring_vendor == $MONITORING_VENDOR_NAGIOS ]]; then
        run /etc/init.d/nagios3 restart
        add_next_step "Icinga monitoring interface: http://${HOSTNAME}/nagios3"
    else
        run /etc/init.d/icinga restart
        add_next_step "Icinga monitoring interface: http://${HOSTNAME}/icinga"
    fi
    
    run /etc/init.d/apache2 reload

}

## Sets up the definition file for a given monitoring host.
##
## $1 nagios flavour/vendor
## $2 <host name>:<ip>, e.g.: fire:192.168.1.100
function set_up_monitoring_host_def()
{
    local file=/etc/icinga/objects/${host_name}_icinga.cfg
    if [[ $1 == $MONITORING_VENDOR_NAGIOS ]]; then
        file=/etc/nagios3/conf.d/${host_name}_nagios2.cfg
    fi
    
    local old_ifs=$IFS
    IFS='#'
    read host_name ip <<< "$2"
    IFS=$old_ifs
    
    if [ $(grep "host_name $host_name" $file 2>/dev/null | wc -l) -gt 0 ]; then
        print "$1 host" $host_name "already defined, skipping it."
        return
    fi
    
    cat >> $file <<EOF
define host {
  use generic-host
  host_name $host_name
  alias $host_name
  address $ip
}

define service {
  use generic-service
  host_name $host_name
  service_description CPU load
  check_command check_nrpe_1arg!check_load
}
EOF

}

function install_nagios_node()
{
    print "Installing an icinga client on $HOSTNAME ..."
    if [ $on_debian_or_derivative -eq 1 ]; then
        install_packages_if_missing nagios-nrpe-server nagios-plugins
    fi
    
    local file=/etc/nagios/nrpe.cfg
    dont_quote_conf_values=1
    set_conf_file_value \
        allowed_hosts \
        127.0.0.1,${fai_monitoring_server_ip} \
        $file
    dont_quote_conf_values=0

    run /etc/init.d/nagios-nrpe-server restart
    add_next_step "A Nagios NRPE node has been installed on ${HOSTNAME}"
}

# munin nodes need the IP of the munin gatherer to be escaped. Hence this function.
# $parameters:
# $1 : the IP
function get_perl_escaped()
{
    local escaped_input=$(
        echo $1 | sed 's/\./\\./g'
    )
    echo "^${escaped_input}$"
}

function install_munin_node()
{
    print_and_log "Installing a Munin node on $HOSTNAME ..."

    # the IP of the monitoring server
    local default_ip=127.0.0.1
    if [ $fai_enabled -eq 1 ]; then
        if [ -n "fai_monitoring_server_ip" ]; then
            monitoring_server_ip=${fai_monitoring_server_ip}
        fi
    elif [ $install_profile_number -ne $PROFILE_MONITORING_SERVER ]; then
        print "What is the IP of your monitoring server? If you don't know"
        print "this, don't worry and just press ENTER"
        echo -n "Your choice [${default_ip}]> "
        read user_monitoring_server

        if [ -n "$user_monitoring_server" ]; then
            monitoring_server_ip=$user_monitoring_server
        fi
    fi

    if [ -z "$monitoring_server_ip" ]; then
        monitoring_server_ip=$default_ip
    fi
    
    if [ $on_debian_or_derivative -eq 1 ]; then
        packages="munin-node munin-plugins-extra munin-java-plugins"
        install_packages_if_missing $packages
    else
        print_and_log "Munin node installation not supported on your system"
        print_and_log "You will have to install it manually."
        return
    fi

    if [ -n "$monitoring_server_ip" ]; then
        escaped_munin_gather_ip=$(get_perl_escaped ${monitoring_server_ip})
        file=/etc/munin/munin-node.conf
        cat >> $file <<EOF

# added by ece-install $(date)
allow ${escaped_munin_gather_ip}
EOF
    fi
    
    # install the escenic_jstat munin plugin
    local file=/usr/share/munin/plugins/escenic_jstat_
    run wget $wget_opts \
        https://github.com/mogsie/escenic-munin/raw/master/escenic_jstat_ \
        -O $file
    run chmod 755 $file

    local instance_list=$(get_instance_list)
    if [ -z "${instance_list}" ]; then
        print_and_log "No ECE instances found on $HOSTNAME, so I'm not adding"
        print_and_log "additional Munin configuration"  
        add_next_step "A Munin node has been installed on $HOSTNAME"
        return
    fi
    
    local escenic_jstat_modules="_gc _gcoverhead _heap _uptime"
    for current_instance in $instance_list; do
        for module in $escenic_jstat_modules; do
	          cd /usr/share/munin/plugins/
	          make_ln escenic_jstat_ escenic_jstat_${current_instance}${module}
        done

        # we need to hack a bit since escenic_jstat_ looks for
        # instance PIDs in $escenic_run_dir ece-<instance>.pid. It's
        # now <type>-<instance>.pid
        file=$escenic_run_dir/$type-${instance_name}.pid
        if [ ! -e $file ]; then
            run touch $file
        fi

        # enabling the instance specific munin entries:
        for el in /usr/share/munin/plugins/escenic_jstat_[a-z]*; do
            run cd /etc/munin/plugins
            make_ln $el
        done
    done

    # TODO in which version(s) of munin is this directory called
    # client-conf.d?
    file=/etc/munin/plugin-conf.d/munin-node
    if [ -e $file ]; then
        cat >> $file <<EOF
[escenic*]
user $ece_user

EOF
    fi
    
    if [ $on_debian_or_derivative -eq 1 ]; then
        run service munin-node restart
    fi

    add_next_step "A Munin node has been installed on $HOSTNAME"
}

function add_server_to_runlevels()
{
    # no need to add init.d scripts to the runlevel(s) for these
    # profiles
    if [ $install_profile_number -eq $PROFILE_WIDGET_FRAMEWORK -o \
         $install_profile_number -eq $PROFILE_DB_SERVER -o \
         $install_profile_number -eq $PROFILE_CACHE_SERVER ]; then
        return
    fi

    if [ $on_debian_or_derivative -eq 1 ]; then
        print_and_log "Adding the ece init.d script to the default run levels ..."
        run update-rc.d ece defaults
    else
        add_next_step "Remember to add /etc/init.d/ece to the desired "\
"run levels." 
        # TODO add init.d to the default runlevels, for other
        # distributions too:
        # - RedHat/chekcconfig
        # - Gentoo: rc-update add ece default
    fi
}

function restore_from_backup()
{
    # locals
    restore_all=0
    restore_db=0
    restore_binaries=0
    restore_data_files=0
    restore_conf=0
    backup_file=""
    backup_dir=$escenic_backups_dir
    
    if [ $(get_boolean_conf_value fai_enabled) -eq 1 -a \
        $(get_boolean_conf_value fai_restore_from_backup) -eq 1 ]; then
        backup_file=${fai_restore_from_file}

        if [ -z "$backup_file" ]; then
            print_and_log "You must specifify fai_restore_from_file"
            remove_pid_and_exit_in_error
        fi

        if [ $(get_boolean_conf_value fai_restore_all) -eq 1 ]; then
            restore_all=1
        elif [ $(get_boolean_conf_value fai_restore_db) -eq 1 ]; then
            restore_db=1
        elif [ $(get_boolean_conf_value fai_restore_data_files) -eq 1 ]; then
            restore_data_files=1
        elif [ $(get_boolean_conf_value fai_restore_software_binaries) -eq 1 ]
        then
            restore_binaries=1
        elif [ $(get_boolean_conf_value fai_restore_configuration) -eq 1 ]; then
            restore_conf=1
        fi
    elif [ $(get_boolean_conf_value fai_enabled) -eq 0 ]; then
        print "From which dataset do you wish to restore?"
        if [ ! -d $backup_dir ]; then
            print_and_log "Directory $backup_dir doesn't exist or isn't readable"
            remove_pid_and_exit_in_error
        fi

        if [ $(ls $backup_dir | grep ".tar$" | wc -l) -lt 1 ]; then
            print_and_log "No backup files (.tar) found in $backup_dir, exiting."
            exit 0
        fi
        
        tarball_array=($(ls -t $backup_dir/*.tar))
        
        for (( i = 0; i <${#tarball_array[@]}; i++ )); do
            echo "   " $(( ${i} + 1 )) "-" $(basename  ${tarball_array[$i]})
        done
        
        print "Enter the number next to the tarball, from 1 to $i"
        echo -n "Your choice [1]> "
        read user_tarball

        if [ -z "$user_tarball" ]; then
            user_tarball=1
        fi

        backup_file=${tarball_array[$(( ${user_tarball} - 1 ))]}

        print "Which part of the system do you wish to restore?"
        restore_profiles=(
            "The database"
            "The Solr and ECE data files (multimedia archive)"
            "The ECE configuration files"
            "The Escenic and Tomcat software binaries + publication templates"
            "Restore everything of the above"
        )
        for (( i = 0; i <${#restore_profiles[@]}; i++ )); do
            echo "   " $(( ${i} + 1 )) "-" ${restore_profiles[$i]}
        done
        
        print "Enter the number next to the tarball, from 1 to $i"
        echo -n "Your choice [1]> "
        read user_restore_profile

        if [ -z "$user_restore_profile" ]; then
            user_restore_profile=1
        fi

        if [ $user_restore_profile -eq 1 ]; then
            restore_db=1
        elif [ $user_restore_profile -eq 2 ]; then
            restore_data_files=1
        elif [ $user_restore_profile -eq 3 ]; then
            restore_conf=1
        elif [ $user_restore_profile -eq 4 ]; then
            restore_binaries=1
        elif [ $user_restore_profile -eq 5 ]; then
            restore_all=1
        fi
    fi

    if [ ! -r "$backup_file" ]; then
        print_and_log "$backup_file either doesn't exist or cannot be read."
        print_and_log "I cannot restore from it :-("
        remove_pid_and_exit_in_error
    fi
    
    dir=$(mktemp -d)
    
    if [ $restore_db -eq 1 -o $restore_all -eq 1 ]; then
        install_database_server "binaries_only"
        print_and_log "Restoring the database contents on $HOSTNAME ..."
        run cd $dir
        run tar xf $backup_file --wildcards var/backups/escenic/*.sql.gz
        # picking the DB backup file to restore
        sql_file=$(ls -tra var/backups/escenic/*.sql.gz | tail -1)
        print_and_log "Selecting database dump: $(basename $sql_file)"

        # methods in drop-and-create-ecedb to set up the database
        # schema & user
        pre_install_new_ecedb
        create_schema

        # db_schema is defined in drop-and-create-ecedb
        gunzip < $sql_file | mysql $db_schema
        exit_on_error "restoring from $sql_file"
        
        add_next_step "Successfully restored DB from $(basename $sql_file)"
    fi
    
    if [ $restore_data_files -eq 1 -o $restore_all -eq 1 ]; then
        print_and_log "Restoring the Solr & ECE data files on $HOSTNAME ..."
        run cd $dir
        run tar -C / -xf $backup_file var/lib/escenic
        add_next_step "Successfully restored Solr & ECE data files"
        add_next_step "Backup file used:  $(basename $backup_file)"
        add_next_step "Check $escenic_data_dir to verify they're all there."
    fi
    
    if [ $restore_conf -eq 1 -o $restore_all -eq 1 ]; then
        print_and_log "Restoring the ECE configuration files on $HOSTNAME ..."
        run cd $dir
        run tar -C / -xf $backup_file etc
        add_next_step "Successfully restored ECE configuration files"
        add_next_step "Backup file used: $(basename $backup_file)"
        add_next_step "Check /etc to verify that they're all there."
    fi
    
    if [ $restore_binaries -eq 1 -o $restore_all -eq 1 ]; then
        print_and_log "Restoring the Escenic & Tomcat binaries on $HOSTNAME ..."
        run cd $dir
        run tar -C / -xf $backup_file opt
        add_next_step "Successfully restored Escenic & Tomcat binaries"
        add_next_step "Backup file used: $(basename $backup_file)"
        add_next_step "Check ${appserver_root_dir} to verify that they're all there".
        install_ece_third_party_packages
        set_up_engine_directories

        # doing some educated guessing on which tomcat_base/home as
        # well as UNIX user/group to use for this.
        file=/etc/default/ece
        if [ -r $file ]; then
            ece_user=$(grep ^ece_unix_user $file | \
                cut -d'=' -f2 | \
                sed -e "s/'//g" -e 's/"//g'
            )
            ece_group=$(grep ^ece_unix_group $file | \
                cut -d'=' -f2 | \
                sed -e "s/'//g" -e 's/"//g'
            )
            create_user_and_group_if_not_present
            
            if [ -d $escenic_conf_dir -a \
                $(ls $escenic_conf_dir/ | grep ^ece- | wc -l) -gt 0 -a \
                $(grep ^tomcat_base $escenic_conf_dir/ece*.conf | wc -l) -gt 0 ]; then
                directories=$(grep ^tomcat_base $escenic_conf_dir/ece*.conf | \
                    cut -d'=' -f2 | \
                    sed -e "s/'//g" -e 's/"//g'
                )
                s="Setting file permissions according to /etc/default/ece"
                print_and_log $s
                s="and $escenic_conf_dir/ece*.conf"
                print_and_log $s
                run chown -R ${ece_user}:${ece_group} ${directories}
            fi
        fi
    fi
}

## $1 configuration file name
## $2 host group name
## $3 host group alias
## $4..n host group members
function set_up_monitoring_host_group()
{
    local file=$1
    local host_group_name=$2
    local host_group_alias=$3
    # the remainding arguments passed to the methods is the member
    # list members
    local host_group_member_list=${@:4:$(( $# - 3 ))}

    if [ $(grep "hostgroup_name $host_group_name" $file | wc -l) -gt 0 ]; then
        print "Icinga group member" \
            $host_group_name \
            "already defined, skipping it."
        return
    fi
    
    cat >> $file <<EOF
define hostgroup {
  hostgroup_name $host_group_name
  alias $host_group_alias
EOF
    echo -n "  members" >> $file
    for el in $host_group_member_list; do
        echo -n " ${el}," >> $file
    done
    cat >> $file <<EOF

}
EOF
}

## $1 nagios vendor
function create_monitoring_server_overview()
{
    local file=/var/www/index.html
    cat > $file <<EOF
<html>
  <body>
    <h1>Welcome to the might monitoring server @ ${HOSTNAME}</h1>
    <ul>
EOF
    if [[ $1 == $MONITORING_VENDOR_NAGIOS ]]; then
        echo '<li><a href="/nagios3">Nagios</a></li>' \
    else
        echo '<li><a href="/icinga">Icinga</a> (an enhanced Nagios)</li>' \
            >> $file
    fi
    cat > $file <<EOF
      <li><a href="/munin">Munin</a></li>
    </ul>
  </body>
</html>
EOF
    add_next_step "Start page for all monitoring interfaces: http://${HOSTNAME}/"
}

MONITORING_VENDOR_NAGIOS=nagios
MONITORING_VENDOR_ICINGA=icinga
function install_monitoring_server()
{
    local nagios_flavour=${fai_monitoring_nagios_flavour-$MONITORING_VENDOR_ICINGA}
    install_nagios_monitoring_server $nagios_flavour
    install_munin_gatherer
    create_monitoring_server_overview $nagios_flavour
}

function common_post_install()
{
    if [ $install_profile_number -eq $PROFILE_ALL_IN_ONE -o \
        $install_profile_number -eq $PROFILE_PRESENTATION_SERVER -o \
        $install_profile_number -eq $PROFILE_RMI_HUB -o \
        $install_profile_number -eq $PROFILE_EDITORIAL_SERVER ]; then
        add_server_to_runlevels
    fi

    if [ $install_profile_number -ne $PROFILE_WIDGET_FRAMEWORK -a \
        $install_profile_number -ne $PROFILE_CREATE_PUBLICATION -a \
        $install_profile_number -ne $PROFILE_RESTORE_FROM_BACKUP ]; then
        install_munin_node

        if [ $install_profile_number -ne $PROFILE_MONITORING_SERVER ]; then
            install_nagios_node
        fi
    fi

    set_correct_permissions
    
    print_status_and_next_steps
    rm $pid_file
}

for el in $@; do
    if [ $el = "-v" -o $el = "--verbose" ]; then
        debug=1
    elif [ $el = "-f" -o $el = "--conf-file" ]; then
        next_is_conf_file=1
    elif [[ -n $next_is_conf_file && $next_is_conf_file -eq 1 ]]; then
        conf_file=$el
        case ${conf_file} in
            /*)
                ;;
            *)
                conf_file=$(pwd)/${conf_file}
                ;;
        esac
        
        next_is_conf_file=0
    fi
done

assert_correct_runtime_environment

fai_enabled=$(get_boolean_conf_value fai_enabled)

if [ $fai_enabled -eq 1 ]; then
    print_and_log "Full Automatic Install (FAI) enabled."
    print_and_log "All user input will be read from $conf_file"
    
    common_pre_install

    no_fai_profile=1
    
    if [ $(get_boolean_conf_value fai_all_install) -eq 1 ]; then
        install_profile_number=$PROFILE_ALL_IN_ONE
        install_all_in_one_environment
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_db_install) -eq 1 ]; then
        install_profile_number=$PROFILE_DB_SERVER
        install_database_server
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_editor_install) -eq 1 ]; then
        install_profile_number=$PROFILE_EDITORIAL_SERVER
        install_editorial_server
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_search_install) -eq 1 ]; then
        install_profile_number=$PROFILE_SEARCH_SERVER
        install_search_server
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_cache_install) -eq 1 ]; then
        install_profile_number=$PROFILE_CACHE_SERVER
        install_cache_server
        install_web_server 0
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_wf_install) -eq 1 ]; then
        install_profile_number=$PROFILE_WIDGET_FRAMEWORK
        install_widget_framework
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_presentation_install) -eq 1 ]; then
        install_profile_number=$PROFILE_PRESENTATION_SERVER
        install_presentation_server
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_publication_create) -eq 1 ]; then
        install_profile_number=$PROFILE_CREATE_PUBLICATION
        create_publication
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_monitoring_install) -eq 1 ]; then
        install_profile_number=$PROFILE_MONITORING_SERVER
        install_monitoring_server
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_restore_from_backup) -eq 1 ]; then
        install_profile_number=$PROFILE_RESTORE_FROM_BACKUP
        restore_from_backup
        no_fai_profile=0
    fi
    
    if [ $(get_boolean_conf_value fai_rmi_install) -eq 1 ]; then
        install_profile_number=$PROFILE_RMI_HUB
        install_rmi_hub
        no_fai_profile=0
    fi

    if [ $(get_boolean_conf_value fai_analysis_install) -eq 1 ]; then
        install_profile_number=$PROFILE_ANALYSIS_SERVER
        install_analysis_server
        no_fai_profile=0
    fi
    
    if [ $no_fai_profile -eq 1 ]; then
        print_and_log "No install profile selected, be sure to have one of the "
        print_and_log "fai_<profile>_install=1 in your $conf_file"
        remove_pid_and_exit_in_error
    fi
    
    common_post_install
else
    read_user_input
    common_pre_install
    
    case $install_profile_number in
        $PROFILE_ALL_IN_ONE)
            install_all_in_one_environment
            ;;
        $PROFILE_CACHE_SERVER)
            install_cache_server
            install_web_server 0
            ;;
        $PROFILE_DB_SERVER)
            install_database_server
            ;;
        $PROFILE_EDITORIAL_SERVER)
            install_editorial_server
            ;;
        $PROFILE_PRESENTATION_SERVER)
            install_presentation_server
            ;;
        $PROFILE_SEARCH_SERVER)
            install_search_server
            ;;
        $PROFILE_RMI_HUB)
            install_rmi_hub
            ;;
        $PROFILE_WIDGET_FRAMEWORK)
            install_widget_framework
            ;;
        $PROFILE_CREATE_PUBLICATION)
            create_publication
            ;;
        $PROFILE_MONITORING_SERVER)
            install_munin_gatherer
            install_web_server 1
            ;;
        $PROFILE_RESTORE_FROM_BACKUP)
            restore_from_backup
            ;;
        *)
            print "Invalid profile number $install_profile_number, must be 1-11"
            remove_pid_and_exit_in_error
            ;;
    esac
    common_post_install
fi

exit 0

